<div id="imageModal" class="image-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <button class="modal-nav modal-prev">&#8249;</button>
    <button class="modal-nav modal-next">&#8250;</button>
    <img id="modalImage" src="" alt="">
    <div id="modalCaption"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  const modalCaption = document.getElementById('modalCaption');
  const modalClose = document.querySelector('.modal-close');
  const modalPrev = document.querySelector('.modal-prev');
  const modalNext = document.querySelector('.modal-next');

  let modalImages = [];
  let currentIndex = -1;
  let currentScale = 1;
  const scaleFactor = 0.1;

  function refreshModalImages() {
    modalImages = Array.from(document.querySelectorAll('.modal-trigger'));
  }

  function updateImageTransform() {
    modalImg.style.transform = `scale(${currentScale})`;
    modalImg.style.transition = 'transform 0.1s ease';
  }

  function openModalAtIndex(index) {
    if (!modalImages.length) {
      return;
    }

    if (index < 0) {
      index = modalImages.length - 1;
    } else if (index >= modalImages.length) {
      index = 0;
    }

    currentIndex = index;
    const target = modalImages[currentIndex];
    if (!target) {
      return;
    }

    const src = target.dataset.modalSrc || target.src;
    const caption = target.getAttribute('data-caption') || target.alt;

    modalImg.src = src;
    modalCaption.textContent = caption || '';
    modal.classList.add('show');
    currentScale = 1;
    updateImageTransform();
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.classList.remove('show');
    document.body.style.overflow = '';
    currentScale = 1;
    currentIndex = -1;
    delete modal.dataset.initialDistance;
  }

  refreshModalImages();

  document.addEventListener('click', function(e) {
    if (!e.target.classList.contains('modal-trigger')) {
      return;
    }

    if (!modalImages.length) {
      refreshModalImages();
    }

    let index = modalImages.indexOf(e.target);
    if (index === -1) {
      refreshModalImages();
      index = modalImages.indexOf(e.target);
    }

    if (index === -1) {
      return;
    }

    openModalAtIndex(index);
  });

  modalClose.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (!modal.classList.contains('show')) {
      return;
    }

    switch (e.key) {
      case 'Escape':
        closeModal();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        openModalAtIndex(currentIndex - 1);
        break;
      case 'ArrowRight':
        e.preventDefault();
        openModalAtIndex(currentIndex + 1);
        break;
      case '+':
      case '=':
        e.preventDefault();
        currentScale = Math.min(currentScale + scaleFactor, 3);
        updateImageTransform();
        break;
      case '-':
        e.preventDefault();
        currentScale = Math.max(currentScale - scaleFactor, 0.1);
        updateImageTransform();
        break;
      case '0':
        e.preventDefault();
        currentScale = 1;
        updateImageTransform();
        break;
    }
  });

  modal.addEventListener('wheel', function(e) {
    if (!modal.classList.contains('show')) {
      return;
    }

    e.preventDefault();
    const delta = e.deltaY > 0 ? -scaleFactor : scaleFactor;
    currentScale = Math.max(0.1, Math.min(3, currentScale + delta));
    updateImageTransform();
  }, { passive: false });

  if (modalPrev) {
    modalPrev.addEventListener('click', function(e) {
      e.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex - 1);
    });
  }

  if (modalNext) {
    modalNext.addEventListener('click', function(e) {
      e.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex + 1);
    });
  }

  modal.addEventListener('touchstart', function(e) {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (e.touches.length === 2) {
      const [touch1, touch2] = e.touches;
      modal.dataset.initialDistance = Math.hypot(
        touch1.clientX - touch2.clientX,
        touch1.clientY - touch2.clientY
      );
    } else {
      e.preventDefault();
    }
  }, { passive: false });

  modal.addEventListener('touchmove', function(e) {
    if (!modal.classList.contains('show') || e.touches.length !== 2) {
      return;
    }

    e.preventDefault();
    const [touch1, touch2] = e.touches;
    const currentDistance = Math.hypot(
      touch1.clientX - touch2.clientX,
      touch1.clientY - touch2.clientY
    );
    const initialDistance = parseFloat(modal.dataset.initialDistance || '0');
    if (initialDistance > 0) {
      const scaleChange = (currentDistance - initialDistance) / initialDistance;
      currentScale = Math.max(0.1, Math.min(3, currentScale + scaleChange * 0.5));
      updateImageTransform();
      modal.dataset.initialDistance = currentDistance;
    }
  }, { passive: false });
});

// PlantUML Hover Tooltip functionality
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('[data-snippet-id]').forEach(function(caption) {
    const snippetId = caption.getAttribute('data-snippet-id');
    const snippetElement = document.getElementById(snippetId);

    if (snippetElement) {
      const content = snippetElement.textContent.replace(/"/g, '&quot;');
      caption.setAttribute('data-tooltip', content);
      caption.classList.add('diagram-caption');
    }
  });
});
</script>
