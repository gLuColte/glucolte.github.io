<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AWS Compute Services ¬∑ glucolte</title>
  <meta name="description" content="notes ‚Ä¢ principles ‚Ä¢ systems">
  <link rel="stylesheet" href="/assets/style.css">
  <link rel="stylesheet" href="/assets/study.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AWS Compute Services | glucolte</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="AWS Compute Services" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="notes ‚Ä¢ principles ‚Ä¢ systems" />
<meta property="og:description" content="notes ‚Ä¢ principles ‚Ä¢ systems" />
<link rel="canonical" href="http://localhost:4000/study/infrastructureAWSCompute" />
<meta property="og:url" content="http://localhost:4000/study/infrastructureAWSCompute" />
<meta property="og:site_name" content="glucolte" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AWS Compute Services" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"notes ‚Ä¢ principles ‚Ä¢ systems","headline":"AWS Compute Services","url":"http://localhost:4000/study/infrastructureAWSCompute"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="site-header">
  <a class="brand" href="/">glucolte</a>
  <nav class="nav">
    <a href="/principles">principles</a>
    <a href="/rules">rules</a>
    <a href="/stretches">stretches</a>
    <a href="/study/">study</a>
    <a href="/projects/">projects</a>
    <a href="/setup/">setup</a>
  </nav>
  <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
    <svg class="sun-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
    <svg class="moon-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>
</header>


  <main class="container">
    <article class="content">
      <h2 id="section-1-aws-compute-overview">1. AWS Compute Overview</h2>

<p>Professional-level design questions expect you to remember that ‚Äúcompute‚Äù isn‚Äôt just EC2 boxes. AWS provides a toolkit and expects architects to combine pieces that best fit the workload‚Äôs shape.</p>

<ul>
  <li><strong>Virtual servers (EC2)</strong> ‚Äì still the go-to when full OS control, custom AMIs, or exotic networking is required.</li>
  <li><strong>Containers (ECS, EKS, Fargate)</strong> ‚Äì great for repeatable deployments and for sprinkling Spot capacity into stateless services.</li>
  <li><strong>Serverless functions (Lambda)</strong> ‚Äì perfect glue for events and bursty jobs because idle time literally costs nothing.</li>
  <li><strong>Edge + load balancing</strong> ‚Äì Route 53, CloudFront, ALB/NLB/GWLB, and Global Accelerator decide <em>where</em> the traffic lands and how TLS is handled.</li>
  <li><strong>Fleet automation</strong> ‚Äì Auto Scaling Groups, launch templates, Parameter Store, and Systems Manager keep fleets patched without manual babysitting.</li>
</ul>

<p>The remaining sections follow a logical progression: start with regional entry points, cover cost levers, tighten up networking, then finish with scaling and inline security.</p>

<hr />

<h2 id="section-2-regional-global-architecture">2. Regional and Global Architecture</h2>

<p>High-level designs usually start at the regional entry point and then trace how traffic fans out globally. Key checkpoints:</p>

<ul>
  <li><strong>Global reach</strong> ‚Äì place workloads close to customers via Regions, edge locations, and CDN nodes.</li>
  <li><strong>Health-aware routing</strong> ‚Äì global health checks and failover policies keep endpoints resilient.</li>
  <li><strong>Scalable ingress</strong> ‚Äì use regional load balancers or Global Accelerator to absorb demand before it reaches your apps.</li>
  <li><strong>Content acceleration</strong> ‚Äì pair compute tiers with CloudFront so static and dynamic responses stay fast worldwide.</li>
</ul>

<div class="image-wrapper">
  <img src="./assets/aws_simplified_architecture.png" alt="Simplified AWS Architecture" class="modal-trigger" data-caption="üåç Regional entry ‚Üí global delivery path" />
  <div class="diagram-caption" data-snippet-id="global-architecture-snippet">
    üåç Regional entry ‚Üí global delivery path
  </div>
  <script type="text/plain" id="global-architecture-snippet">
@startuml
title Simplified AWS Architecture - Sequence Flow

actor User as U

participant "Route 53\n(Global DNS)" as R53
participant "CloudFront\n(CDN + Edge)" as CF
participant "Web Tier\n(ALB / API Gateway)" as WEB
participant "Compute Tier\n(EC2 / ECS / Lambda)" as COMP
participant "Caching\n(ElastiCache / DynamoDB DAX)" as CACHE
participant "DB Tier\n(RDS / Aurora / DynamoDB)" as DB
participant "App Services\n(SQS / SNS / EventBridge / Step Fn)" as APPS
participant "Storage\n(S3 / EFS)" as STORE

U -> R53: DNS lookup for application domain
R53 -> CF: Resolve best global edge location

U -> CF: HTTPS request (cached/static objects first check)
CF -> WEB: Forward request if not cached

WEB -> COMP: Application request (HTTP/HTTPS)
COMP -> CACHE: Read cached data?
alt Cache HIT
    CACHE --> COMP: Return cached data
else Cache MISS
    COMP -> DB: Query data / retrieve records
    DB --> COMP: Return data
    COMP -> CACHE: Write into cache (optional)
end

COMP -> APPS: Async tasks / events (SNS/SQS/EventBridge)
APPS --> COMP: Ack accepted

COMP -> STORE: Read/write files (images, logs, assets)
STORE --> COMP: Return stored content metadata

COMP --> WEB: Build response
WEB --> CF: Send response (cache based on policy)
CF --> U: Return final response (with caching headers)

@enduml
  </script>
</div>

<hr />

<h2 id="section-3-ec2-purchase-savings-strategies">3. EC2 Purchase &amp; Savings Strategies</h2>

<p>After the region/edge layout is clear, cost strategy becomes the next focus. Picking the right commercial model matters just as much as sizing instances, so the tables below act as a quick reference for when each option shines.</p>

<h3 id="section-3-1-standard-purchase-options">3.1 Standard Purchase Options</h3>

<table class="study-table">
<thead>
<tr>
<th>Model</th>
<th>Billing Traits</th>
<th>Best For</th>
<th>Key Watchouts</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>On-Demand</strong></td>
<td>Per-second billing on shared hardware, no commitments.</td>
<td>Default choice for short-lived, unpredictable, or interruption-intolerant tasks.</td>
<td>Most expensive rate; capacity not reserved.</td>
</tr>
<tr>
<td><strong>Spot</strong></td>
<td>Per-second billing, deep discounts (up to ~90%) on unused capacity.</td>
<td>Stateless, batch, or flexible jobs that can handle sudden interruptions.</td>
<td>Instances can disappear with little warning; design retry logic.</td>
</tr>
<tr>
<td><strong>Reserved Instances</strong></td>
<td>Commit to 1 or 3 years for reduced hourly rates; zonal RIs also reserve capacity.</td>
<td>Always-on workloads with predictable instance families/regions.</td>
<td>Locked to attributes (region, tenancy, family). Unused reservations still bill.</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="section-3-2-dedicated-capacity-choices">3.2 Dedicated Capacity Choices</h3>

<table class="study-table">
<thead>
<tr>
<th>Option</th>
<th>What You Get</th>
<th>Ideal Use</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dedicated Host</strong></td>
<td>Entire physical server under your control; BYOL-friendly.</td>
<td>Socket/core-licensed software, strict compliance, pinning instances.</td>
<td>You manage host capacity; pair with Host Affinity for placement guarantees.</td>
</tr>
<tr>
<td><strong>Dedicated Instance</strong></td>
<td>Instance runs on hardware isolated to your account, but AWS manages hosts.</td>
<td>Isolation requirements without host-level management.</td>
<td>No host visibility; pay instance fees with dedicated tenancy surcharge.</td>
</tr>
</tbody>
</table>

<div class="image-wrapper">
  <img src="./assets/dedicated_host.png" alt="Dedicated Host/Instances" class="modal-trigger" data-caption="üß© EC2 tenancy isolation options" />
  <div class="diagram-caption" data-snippet-id="dedicated-tenancy-snippet">
    üß© EC2 tenancy isolation options
  </div>
  <script type="text/plain" id="dedicated-tenancy-snippet">
flowchart TB

%% ------------ DEFAULT / SHARED HOST ------------
subgraph SHARED["DEFAULT / SHARED"]
    direction TB

    subgraph SH_HOST["EC2 HOST"]
        SH1([Your EC2]):::mine
        SH2([Others]):::other
        SH3([Others]):::other
        SH4([Your EC2]):::mine
        SH5([Others]):::other
    end
end

style SHARED fill:#e6f7ff,stroke:#0077b6,stroke-width:2px
style SH_HOST fill:#ffffff,stroke:#0077b6,stroke-width:1px


%% ------------ DEDICATED HOST ------------
subgraph DEDHOST["DEDICATED HOST"]
    direction TB

    subgraph DH_HOST["EC2 HOST "]
        DH1([Your EC2]):::mine
        DH2([Your EC2]):::mine
        DH3([Your EC2]):::mine
        DH4([Your EC2]):::mine
    end
end

style DEDHOST fill:#ffe6f2,stroke:#d63384,stroke-width:2px
style DH_HOST fill:#ffffff,stroke:#d63384,stroke-width:1px


%% ------------ DEDICATED INSTANCES ------------
subgraph DEDINST["DEDICATED INSTANCES"]
    direction TB

    subgraph DI_HOST["EC2 HOST"]
        DI1([Your EC2]):::mine
        DI_BLANK1([Reserved / Not shared]):::unused
        DI_BLANK2([Reserved / Not shared]):::unused
        DI2([Your EC2]):::mine
    end
end

style DEDINST fill:#fff3cd,stroke:#ff9500,stroke-width:2px
style DI_HOST fill:#ffffff,stroke:#ff9500,stroke-width:1px


%% ------------ COLOR DEFINITIONS ------------
classDef mine fill:#ff6b81,color:#ffffff,stroke-width:0px;
classDef other fill:#868e96,color:#ffffff,stroke-width:0px;
classDef unused fill:#adb5bd,color:#ffffff,stroke-width:0px;
  </script>
</div>

<p>Quick note to future me: a <em>host</em> is the single physical server that runs the VMs, while a <em>rack</em> is the collection of hosts an AWS placement group carves up.</p>

<hr />

<h3 id="section-3-3-reserved-instance-flavors">3.3 Reserved Instance Flavors</h3>

<ul>
  <li><strong>Scheduled RIs</strong> ‚Äì Reserve recurring blocks (e.g., nightly batch for 5 hours). Minimum 1-year contract (~1,200 hrs/year). Not every region or family supported.</li>
  <li><strong>Regional RIs</strong> ‚Äì Apply discounts to matching instances in any AZ of the region, but do not reserve capacity.</li>
  <li><strong>Zonal RIs</strong> ‚Äì Attach to one AZ; gain both billing discount and capacity reservation.</li>
  <li><strong>On-Demand Capacity Reservations</strong> ‚Äì Guarantee capacity inside an AZ without term commitments. Pair with RIs or Savings Plans for discounts when possible.</li>
</ul>

<hr />

<h3 id="section-3-4-savings-plans">3.4 Savings Plans</h3>

<ul>
  <li>Commit to spend <strong>$X/hour</strong> for 1 or 3 years to unlock reduced rates.</li>
  <li><strong>Compute Savings Plans</strong> apply across EC2, Fargate, and Lambda, regardless of instance family or region.</li>
  <li><strong>EC2 Instance Savings Plans</strong> limit flexibility (family + region) but offer deeper discounts.</li>
</ul>

<hr />

<h3 id="section-3-5-taxi-analogy-for-charging-models">3.5 Taxi Analogy for Charging Models</h3>

<table class="study-table">
<thead>
<tr>
<th>Plan</th>
<th>Plain-English Explanation</th>
<th>Taxi Analogy üöï</th>
<th>Commitment</th>
<th>Capacity Guaranteed?</th>
<th>Discount?</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>On-Demand</strong></td>
<td>Pay only while the instance runs.</td>
<td>Hail a taxi whenever needed.</td>
<td>None</td>
<td>‚ùå</td>
<td>‚ùå</td>
<td>Tests, spikes, unpredictable workloads.</td>
</tr>
<tr>
<td><strong>Savings Plan</strong></td>
<td>Promise to spend $/hr for discount, flexible usage.</td>
<td>Retainer for any taxi ride at lower price.</td>
<td>1‚Äì3 yrs</td>
<td>‚ùå</td>
<td>‚úÖ</td>
<td>Continuous usage that may change families/regions.</td>
</tr>
<tr>
<td><strong>Reserved Instance</strong></td>
<td>Lock specific attributes for big discount.</td>
<td>Lease the same taxi full-time.</td>
<td>1‚Äì3 yrs</td>
<td>‚ùå (‚úÖ for zonal)</td>
<td>‚úÖ</td>
<td>Steady 24√ó7 fleets.</td>
</tr>
<tr>
<td><strong>Scheduled RI</strong></td>
<td>Recurring reserved blocks.</td>
<td>Pre-book the same taxi for rush hour.</td>
<td>1 yr</td>
<td>‚úÖ (during window)</td>
<td>‚úÖ</td>
<td>Predictable periodic jobs.</td>
</tr>
<tr>
<td><strong>Capacity Reservation</strong></td>
<td>Keep capacity idle but ready.</td>
<td>Pay driver to wait while you shop.</td>
<td>Open-ended</td>
<td>‚úÖ</td>
<td>‚ùå (unless paired)</td>
<td>Mission-critical or DR kickoffs.</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="section-3-6-dedicated-options-recap">3.6 Dedicated Options Recap</h3>

<table class="study-table">
<thead>
<tr>
<th>Option</th>
<th>Analogy</th>
<th>Discount Potential</th>
<th>Why choose it</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dedicated Instance</strong></td>
<td>Private taxi, company-owned.</td>
<td>‚ùå</td>
<td>Compliance isolation without hardware management.</td>
</tr>
<tr>
<td><strong>Dedicated Host</strong></td>
<td>Lease the whole car.</td>
<td>‚úÖ (with RIs/SP)</td>
<td>BYOL licensing, socket/core tracking, placement control.</td>
</tr>
</tbody>
</table>

<hr />

<h2 id="section-4-ec2-networking-image-strategy">4. EC2 Networking &amp; Image Strategy</h2>

<p>Cost planning is pointless if instances can‚Äôt talk or boot quickly, so the next pass is all about ENIs and image hygiene.</p>

<h3 id="section-4-1-elastic-network-interfaces">4.1 Elastic Network Interfaces (ENIs)</h3>

<ul>
  <li><strong>Scoped to an AZ</strong>: an ENI lives in a subnet, so you can only attach it to instances in the same AZ.</li>
  <li><strong>Static identity</strong>: primary private IPv4 never changes for the lifetime of the ENI.</li>
  <li><strong>Addresses</strong>: support multiple secondary IPv4s, IPv6 assignments, and an Elastic IP per private IPv4 if needed.</li>
  <li><strong>Security constructs</strong>: attach multiple security groups, leverage source/destination checks, and gain a unique MAC address (handy for licensed software).</li>
  <li><strong>Attachment patterns</strong>: add multiple ENIs per instance (subject to type limits) for different security zones or management planes.</li>
</ul>

<hr />

<h3 id="section-4-2-bootstrapping-vs-ami-baking">4.2 Bootstrapping vs. AMI Baking</h3>

<p>Application provisioning typically follows three layers:</p>

<ol>
  <li><strong>Base OS + Dependencies</strong> ‚Äì slowest layer, rarely changes.</li>
  <li><strong>Application Binaries</strong> ‚Äì updated occasionally.</li>
  <li><strong>Runtime Configuration</strong> ‚Äì fast, environment-specific tweaks.</li>
</ol>

<p><strong>Strategies:</strong></p>

<ul>
  <li><strong>User Data scripts</strong> ‚Äì customize step 1 or 2 at launch time; flexible but slower to become ready.</li>
  <li><strong>AMI Baking</strong> ‚Äì pre-build golden images with the heavy lifting done; fastest boot but requires pipeline updates when components change.</li>
  <li><strong>Dynamic config (Parameter Store / AppConfig)</strong> ‚Äì keep step 3 lightweight and environment-aware.</li>
</ul>

<p>Optimal builds usually blend baked AMIs for heavy dependencies plus minimal bootstrapping for secrets, region settings, or last-minute patches.</p>

<hr />

<h2 id="section-5-elastic-load-balancing">5. Elastic Load Balancing</h2>

<p>With networking squared away, the next layer is the load balancers that shape every request before it hits compute.</p>

<h3 id="section-5-1-architecture-traffic-flow">5.1 Architecture &amp; Traffic Flow</h3>

<ul>
  <li>Deploy load balancers across at least two subnets (one per AZ) to decouple presentation and application tiers.</li>
  <li>Each ELB exposes a DNS name; clients resolve it to per-AZ nodes.</li>
  <li>Listeners inspect protocol, port, and rule sets, then forward to target groups over private networking.</li>
  <li>Targets respond via the node, while health checks continuously verify status.</li>
  <li>Allocate /27-sized subnets (8+ free IPs) so nodes can scale out when demand spikes.</li>
</ul>

<div class="image-wrapper">
  <img src="./assets/aws_elb_architecture.png" alt="ELB Architecture" class="modal-trigger" data-caption="‚öñÔ∏è ELB request flow (public + internal tiers)" />
  <div class="diagram-caption" data-snippet-id="elb-architecture-snippet">
    ‚öñÔ∏è ELB request flow (public + internal tiers)
  </div>
    <!-- Keep your PlantUML raw here -->
  <script type="text/plain" id="elb-architecture-snippet">
@startuml
title ELB Architecture + ELB Request Logic

actor User

participant "Route 53\n(A record ‚Üí ELB DNS)" as R53
participant "Public ELB Node\n(Internet Facing)" as P_ELB
participant "Target Group" as TG
participant "Public EC2\n(Web Tier)" as PUB_EC2
participant "Private EC2\n(Web Tier)" as PRIV_EC2_WEB
participant "Internal ELB\n(Private Only)" as I_ELB
participant "Private EC2\n(App Tier)" as PRIV_EC2_APP


User -> R53: DNS Lookup (A record ‚Üí ELB DNS name)
R53 --> User: Returns IP of an ELB node\n(may be any AZ)

User -> P_ELB: HTTP/HTTPS request hits ELB Node

note right of P_ELB
ELB internal flow:
1. Listener identifies port/protocol (e.g. HTTP:80 / HTTPS:443)
2. Listener checks rules (path, host-header, conditions)
3. Select healthy target using LB algorithm (round-robin/LC)
4. Sends traffic to target ENI
5. Maintains stickiness + performs health checks
end note

P_ELB -> TG: Check healthy targets

alt Target is Public EC2
    TG -> PUB_EC2: Forward request
    PUB_EC2 --> TG: Response
else Target is Private EC2
    TG -> PRIV_EC2_WEB: Forward request
    PRIV_EC2_WEB --> TG: Response
end

== Scaling tier-to-tier ==
PRIV_EC2_WEB -> I_ELB: HTTP/HTTPS request (private-only LB)
I_ELB -> PRIV_EC2_APP: Forward request
PRIV_EC2_APP --> I_ELB: Response

TG --> P_ELB: Return response
P_ELB --> User: Final HTTP/HTTPS response

@enduml
  </script>
</div>

<hr />

<h3 id="section-5-2-cross-zone-load-balancing">5.2 Cross-Zone Load Balancing</h3>

<ul>
  <li>Default behavior is <strong>per-AZ balancing</strong> ‚Äì each AZ receives an equal portion of traffic regardless of how many instances run inside it.</li>
  <li>Enable <strong>cross-zone</strong> to redistribute surplus requests from lightly provisioned AZs to others, preventing single-instance AZs from being overloaded.</li>
</ul>

<div class="image-wrapper">
  <img src="./assets/cross_zone_loadbalancing.png" alt="ELB Architecture - Cross Zone" class="modal-trigger" data-caption="üîÅ Cross-zone load balancing fan-out" />
  <div class="diagram-caption" data-snippet-id="cross-zone-snippet">
    üîÅ Cross-zone load balancing fan-out
  </div>
    <!-- Keep your PlantUML raw here -->
  <script type="text/plain" id="cross-zone-snippet">
flowchart LR
    subgraph ClientSide["Client"]
        U[User Browser]
    end

    U -->|resolves DNS| LB_DNS["ALB / NLB DNS Name"]

    subgraph VPC["VPC (us-east-1)"]
        direction LR
        
        subgraph AZA["AZ A"]
            LB_A["LB Node (AZ A)"]
            EC2_A1["Target EC2 A1"]
            EC2_A2["Target EC2 A2"]
        end

        subgraph AZB["AZ B"]
            LB_B["LB Node (AZ B)"]
            EC2_B1["Target EC2 B1"]
        end
    end

    LB_DNS --> LB_A
    LB_DNS --> LB_B

    %% Cross-zone balancing
    LB_A --> EC2_A1
    LB_A --> EC2_A2
    LB_A --> EC2_B1

    LB_B --> EC2_A1
    LB_B --> EC2_A2
    LB_B --> EC2_B1
  </script>
</div>

<hr />

<h3 id="section-5-3-user-session-state">5.3 User Session State</h3>

<ul>
  <li>Stateful features (shopping carts, wizards, login state) should ideally live in shared stores (Redis, DynamoDB) so any node can serve the next request.</li>
  <li>If server memory must hold state, use stickiness cautiously and plan for disruption during instance rotations.</li>
</ul>

<hr />

<h3 id="section-5-4-load-balancer-generations">5.4 Load Balancer Generations</h3>

<table class="study-table">
<thead>
<tr>
<th>Type</th>
<th>Protocols</th>
<th>Highlights</th>
<th>Limitations</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Classic LB (CLB)</strong></td>
<td>HTTP/HTTPS/TCP</td>
<td>Legacy option, basic Layer 4/7 support.</td>
<td>No SNI, only one SSL cert, minimal app awareness.</td>
</tr>
<tr>
<td><strong>Application LB (ALB)</strong></td>
<td>HTTP/HTTPS/WebSocket</td>
<td>True Layer 7: content-based routing, multiple certs, WebSockets.</td>
<td>No TCP/UDP listeners; TLS terminates at ALB.</td>
</tr>
<tr>
<td><strong>Network LB (NLB)</strong></td>
<td>TCP/TLS/UDP</td>
<td>Ultra-low latency, static IPs, preserves end-to-end encryption.</td>
<td>No HTTP header visibility or cookies.</td>
</tr>
<tr>
<td><strong>Gateway LB (GWLB)</strong></td>
<td>GENEVE encapsulated L3/L4</td>
<td>Auto-scales third-party appliances inline.</td>
<td>Requires appliance support for GENEVE.</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="section-5-5-session-stickiness">5.5 Session Stickiness</h3>

<ul>
  <li>ALB/CLB can inject cookies (e.g., <code class="language-plaintext highlighter-rouge">AWSALB</code>) lasting 1 second to 7 days to bind a client to a target.</li>
  <li>Stickiness helps when external caching isn‚Äôt available but can skew load or trap users on draining instances.</li>
</ul>

<hr />

<h3 id="section-5-6-connection-draining-deregistration-delay">5.6 Connection Draining &amp; Deregistration Delay</h3>

<ul>
  <li><strong>Connection Draining (CLB)</strong> ‚Äì allows 1‚Äì3600 seconds for in-flight requests to finish before removing a node.</li>
  <li><strong>Deregistration Delay (ALB/NLB)</strong> ‚Äì configured per target group (default 300s) so existing flows complete gracefully after a scale-in event.</li>
</ul>

<hr />

<h3 id="section-5-7-client-ip-preservation">5.7 Client IP Preservation</h3>

<ul>
  <li>For HTTP/HTTPS, ALB adds <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code>, <code class="language-plaintext highlighter-rouge">X-Forwarded-Proto</code>, and <code class="language-plaintext highlighter-rouge">X-Forwarded-Port</code> headers; read the leftmost IP to find the original client.</li>
  <li>For non-HTTP traffic, enable the <strong>Proxy Protocol</strong> (Layer 4). CLB uses v1 (text), NLB uses v2 (binary) to deliver client source info while keeping TLS intact.</li>
</ul>

<hr />

<h2 id="section-6-auto-scaling-groups">6. Auto Scaling Groups (ASG)</h2>

<p>All that front-door engineering falls flat without an automated fleet, so this section collects focused ASG reminders.</p>

<h3 id="section-6-1-core-concepts">6.1 Core Concepts</h3>

<ul>
  <li>Use launch templates (preferred) or launch configurations to define AMI, networking, storage, and metadata.</li>
  <li>Set <strong>min</strong>, <strong>desired</strong>, and <strong>max</strong> capacity to bound fleet size.</li>
  <li>ASGs self-heal: failed instances trigger replacement up to desired capacity.</li>
  <li>Operate only inside a VPC but can span multiple subnets/AZs for resilience.</li>
</ul>

<div class="image-wrapper">
  <img src="./assets/asg_sequence.png" alt="ASG Sequence" class="modal-trigger" data-caption="‚öôÔ∏è ASG lifecycle hook timeline" />
  <div class="diagram-caption" data-snippet-id="asg-sequence-snippet">
    ‚öôÔ∏è ASG lifecycle hook timeline
  </div>
    <!-- Keep your PlantUML raw here -->
  <script type="text/plain" id="asg-sequence-snippet">
@startuml
title Auto Scaling Group Lifecycle Hooks (Scale-Out + Scale-In)

actor "Auto Scaling Group" as ASG
participant "EC2 Instance" as EC2
participant "Lifecycle Hook" as HOOK
participant "SNS / EventBridge" as EVT

== Scale OUT ==

ASG -> EC2: Launch new instance
EC2 -> HOOK: State = PENDING:WAIT\nLifecycle hook triggered
HOOK -> EVT: Publish event (SNS / EventBridge)

note over EVT
External process can initialize:
- app bootstrap
- data indexing / config
end note

EVT -> HOOK: CompleteLifecycleAction\n(continue or abandon)

HOOK -> EC2: State = PENDING:PROCEED
EC2 -> ASG: Instance ready
ASG -> EC2: State = InService


== Scale IN ==

ASG -> EC2: Mark instance for termination
EC2 -> HOOK: State = TERMINATING:WAIT\nLifecycle hook triggered
HOOK -> EVT: Publish event (SNS / EventBridge)

note over EVT
External process can do:
- backup logs
- drain connections
end note

EVT -> HOOK: CompleteLifecycleAction\n(continue termination)

HOOK -> EC2: State = TERMINATING:PROCEED
EC2 -> ASG: Termination completed
ASG -> EC2: State = TERMINATED

@enduml
  </script>
</div>

<hr />

<h3 id="section-6-2-scaling-policies">6.2 Scaling Policies</h3>

<ul>
  <li><strong>Manual</strong> ‚Äì operators change desired count directly (no policy required).</li>
  <li><strong>Scheduled</strong> ‚Äì scale for predictable daily/weekly events.</li>
  <li><strong>Dynamic</strong> ‚Äì react to CloudWatch metrics:
    <ul>
      <li><em>Simple</em> scaling: single threshold ‚Üí fixed adjustment.</li>
      <li><em>Step</em> scaling: multiple thresholds map to incremental adjustments.</li>
      <li><em>Target tracking</em>: maintain a metric near a setpoint (thermostat-style).</li>
    </ul>
  </li>
  <li><strong>SQS-driven</strong> ‚Äì trigger scaling from queue depth (e.g., <code class="language-plaintext highlighter-rouge">ApproximateNumberOfMessagesVisible</code>).</li>
  <li>Cooldowns prevent thrashing; customize per policy.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TARGET_CPU</span> <span class="o">=</span> <span class="mi">50</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">get_average_cpu</span><span class="p">(</span><span class="n">asg_instances</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">-</span> <span class="n">TARGET_CPU</span>

    <span class="k">if</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">desired_instances</span> <span class="o">&lt;</span> <span class="n">max_instances</span><span class="p">:</span>
        <span class="n">scale_out</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span> <span class="ow">and</span> <span class="n">desired_instances</span> <span class="o">&gt;</span> <span class="n">min_instances</span><span class="p">:</span>
        <span class="n">scale_in</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cooldown</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div></div>

<table class="study-table">
<thead>
<tr>
<th>Policy</th>
<th>Behavior</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Simple</strong></td>
<td>One metric threshold, one action.</td>
<td>‚ÄúIf CPU &gt; 70%, add 1 instance.‚Äù</td>
</tr>
<tr>
<td><strong>Step</strong></td>
<td>Multiple bands with different step sizes.</td>
<td>‚Äú&gt;90% add 3, &gt;70% add 2‚Ä¶‚Äù</td>
</tr>
<tr>
<td><strong>Target Tracking</strong></td>
<td>Feedback loop aims for target metric.</td>
<td>Works like cruise control; AWS manages math.</td>
</tr>
</tbody>
</table>

<h3 id="section-6-3-health-checks-hooks">6.3 Health Checks &amp; Hooks</h3>

<ul>
  <li><strong>Health sources</strong>: EC2 status (default), ELB health, or custom integration.</li>
  <li><strong>Grace period</strong>: default 300s before first health check to allow bootstrapping.</li>
  <li><strong>Lifecycle hooks</strong> pause instances during <code class="language-plaintext highlighter-rouge">Pending</code> or <code class="language-plaintext highlighter-rouge">Terminating</code> steps so you can run custom scripts (e.g., pre-warm cache, drain sessions). Resume via <code class="language-plaintext highlighter-rouge">CompleteLifecycleAction</code> or wait for timeout.</li>
</ul>

<h3 id="section-6-4-asgs-with-load-balancers">6.4 ASGs with Load Balancers</h3>

<ul>
  <li>Register ASG with target groups; new instances join automatically.</li>
  <li>Optionally rely on load balancer health checks so failing targets are replaced even if EC2 reports ‚Äúok.‚Äù</li>
  <li>Deregistration delays + lifecycle hooks create graceful scale-in workflows.</li>
</ul>

<hr />

<h2 id="section-7-ec2-placement-groups">7. EC2 Placement Groups</h2>

<p>When latency or blast-radius guarantees show up, placement groups keep the topology honest.</p>

<table class="study-table">
<thead>
<tr>
<th>Strategy</th>
<th>Layout</th>
<th>Best For</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Cluster</strong></td>
<td>Packs instances close together in one AZ.</td>
<td>HPC, tightly coupled apps needing 10 Gbps+ per flow.</td>
<td>No cross-AZ spreading; low resilience. Launch similar instances simultaneously for best results.</td>
</tr>
<tr>
<td><strong>Spread</strong></td>
<td>Places up to 7 instances per AZ on distinct racks with separate power/network.</td>
<td>Small fleets needing maximum isolation (critical services, HA pairs).</td>
<td>Not available for Dedicated Hosts/Instances; limit 7 per AZ.</td>
</tr>
<tr>
<td><strong>Partition</strong></td>
<td>Segments racks into partitions; instances within a partition share hardware, but partitions are isolated.</td>
<td>Large-scale distributed systems (Hadoop, Cassandra, Kafka).</td>
<td>Up to 7 partitions per AZ; you assign instances to partitions for failure-domain control.</td>
</tr>
</tbody>
</table>

<div class="image-wrapper">
  <img src="./assets/ec2_placement_group.png" alt="EC2 Placement Group" class="modal-trigger" data-caption="üß± Placement group rack layout" />
  <div class="diagram-caption" data-snippet-id="placement-snippet">
    üß± Placement group rack layout
  </div>
    <!-- Keep your PlantUML raw here -->
  <script type="text/plain" id="placement-snippet">
flowchart TB

%% ------------------ SPREAD ------------------
subgraph SPREAD["SPREAD PLACEMENT"]
    direction LR

    subgraph S_R1["Rack 1"]
        S1((EC2))
    end

    subgraph S_R2["Rack 2"]
        S2((EC2))
    end

    subgraph S_R3["Rack 3"]
        S3((EC2))
    end
end
style SPREAD fill:#ddffdd,stroke:#2ecc71,stroke-width:2px


%% ------------------ PARTITION ------------------
subgraph PARTITION["PARTITION PLACEMENT"]
    direction LR

    subgraph P1["Rack 1"]
        P1R1((EC2))
        P1R2((EC2))
        P1R3((EC2))
    end

    subgraph P2["Rack 2"]
        P2R1((EC2))
    end

    subgraph P3["Rack 3"]
        P3R1((EC2))
        P3R2((EC2))
    end

end
style PARTITION fill:#ddeaff,stroke:#3498db,stroke-width:2px


%% ------------------ CLUSTER ------------------
subgraph CLUSTER["CLUSTER PLACEMENT"]
    direction LR

    subgraph C_R1["Rack 1"]
        C1((EC2))
        C2((EC2))
        C3((EC2))
        C4((EC2))
    end

    subgraph C_R2["Rack 2"]
    end

    subgraph C_R3["Rack 3"]
    end
end
style CLUSTER fill:#ffe3e3,stroke:#e74c3c,stroke-width:2px
  </script>
</div>

<hr />

<h2 id="section-8-gateway-load-balancer">8. Gateway Load Balancer (GWLB)</h2>

<p>The final piece is inline security. GWLB keeps third-party appliances elastic so next hops are not hard-coded everywhere.</p>

<p>Traditional inspection tiers often require manually chaining firewalls or IDS appliances, creating scaling pain. GWLB changes that by:</p>

<ul>
  <li>Planting <strong>GWLB Endpoints</strong> (PrivateLink) inside each subnet, so routing can hairpin through inspection with a single hop.</li>
  <li>Wrapping flows in <strong>GENEVE</strong> and shipping them to a managed GWLB service that knows about health, scaling, and AZ isolation.</li>
  <li>Treating appliance fleets like any other target group, which means health checks, scaling, and fail-open/fail-closed logic stay consistent.</li>
  <li>Preserving the original source/destination IPs so the security rules stay accurate after inspection.</li>
</ul>

<div class="image-wrapper">
  <img src="./assets/gwlb_architecture.png" alt="GWLB Architecture" class="modal-trigger" data-caption="üõ°Ô∏è GWLB inline inspection flow" />
  <div class="diagram-caption" data-snippet-id="gwlb-snippet">
    üõ°Ô∏è GWLB inline inspection flow
  </div>
    <!-- Keep your PlantUML raw here -->
  <script type="text/plain" id="gwlb-snippet">
@startuml
title Gateway Load Balancer ‚Äî Ingress Inspection (GWLB before ALB)

skinparam participant {
    BackgroundColor<<AppVPC>> #ffe6f2
    BorderColor<<AppVPC>> #ff4da6
    BackgroundColor<<SecurityVPC>> #e6f0ff
    BorderColor<<SecurityVPC>> #4d79ff
}

actor Client

box "Application VPC (Ingress VPC ‚Äî user's web request arrives here)" #ffe6f2
participant "GWLB Endpoint (GWLB-E)\nActs as next-hop in route table" as GWLBE <<AppVPC>>
participant "ALB\n(Application Load Balancer)" as ALB <<AppVPC>>
participant "App Target\n(EC2 / ECS / Lambda)" as APP <<AppVPC>>
end box

box "Security VPC (Inspection appliances)" #e6f0ff
participant "GWLB\n(Gateway Load Balancer)" as GWLB <<SecurityVPC>>
participant "Security Appliance\n(Firewall / IDS / IPS)" as APPLIANCE <<SecurityVPC>>
end box


== Ingress Request ==

Client -> GWLBE: 1. Client connects to public endpoint\n(route table sends traffic to GWLB-E)

GWLBE -> GWLB: 2. GENEVE encapsulation\n(original packet untouched)

GWLB -> APPLIANCE: 3. Forward encapsulated packet for inspection

APPLIANCE --> GWLB: 4. ALLOW / DENY / MODIFY decision

GWLB -> GWLBE: 5. Return encapsulated packet\n(symmetric return path)

GWLBE -> ALB: 6. Decapsulate, send ORIGINAL packet to ALB\n(no NAT, retains real client IP)

== Now load balancer routing ==

ALB -> APP: 7. ALB selects backend target\n(target group evaluation)

APP --> ALB: 8. Application response


== Outbound return traffic must also be inspected ==

ALB -> GWLBE: 9. Route table forces return traffic back to GWLB-E
GWLBE -> GWLB: 10. Encapsulate again (GENEVE)
GWLB -> APPLIANCE: 11. Return path inspection
APPLIANCE --> GWLB: 12. Decision
GWLB -> GWLBE: 13. Send cleaned packet back
GWLBE -> Client: 14. Final response to user

@enduml
  </script>
</div>

<p>Use cases:</p>

<ol>
  <li><strong>Centralized security VPC</strong> ‚Äì route spoke VPC traffic via GWLB endpoints for inspection before reaching workloads.</li>
  <li><strong>Inline egress filtering</strong> ‚Äì send outbound flows through IDS/IPS without hard-wiring next hops.</li>
  <li><strong>Scalable appliances</strong> ‚Äì autoscale firewall AMIs with GWLB controlling attachment and health.</li>
</ol>

<hr />

<h2 id="section-8-operations-notes">8. Operations &amp; Exam Notes</h2>

<ul>
  <li><strong>EC2 lifecycle</strong> ‚Äì Reboot keeps the same host and IPs; Stop/Start moves to new hardware with a new public IP (unless EIP) and wipes instance store volumes.</li>
  <li><strong>ENIs</strong> ‚Äì secondary ENIs retain MAC/IP identity across stops; useful for licensing or failover IP swaps.</li>
  <li><strong>ALB refresh</strong> ‚Äì regional service with nodes (ENIs) in each subnet; stickiness is configured at the Target Group, not on the listener.</li>
  <li><strong>Lambda@Edge</strong> ‚Äì deploys Lambda functions to CloudFront PoPs for viewer/origin request/response manipulation (auth headers, redirects, AB tests).</li>
  <li><strong>ECS networking modes</strong> ‚Äì <code class="language-plaintext highlighter-rouge">bridge</code> (containers NAT behind host) vs <code class="language-plaintext highlighter-rouge">awsvpc</code> (task receives its own ENI, required for Fargate/Service Discovery).</li>
  <li><strong>Systems Manager Run/Session Manager</strong> ‚Äì requires SSM Agent plus the <code class="language-plaintext highlighter-rouge">AmazonSSMManagedInstanceCore</code> role and VPC endpoints (<code class="language-plaintext highlighter-rouge">ssm</code>, <code class="language-plaintext highlighter-rouge">ec2messages</code>, <code class="language-plaintext highlighter-rouge">ssmmessages</code>) when no Internet access.</li>
  <li><strong>Elastic Beanstalk deployments</strong> ‚Äì All-at-once (downtime), Rolling, Rolling with extra batch, Immutable, or Blue/Green (CNAME swap). Worker environments use SQS + EC2.</li>
  <li><strong>Elastic Fabric Adapter (EFA)</strong> ‚Äì HPC ENI with OS-bypass (Libfabric). Needs supported instances (e.g., c5n, p4d, hpc6a) + placement group + EFA-enabled AMI.</li>
  <li><strong>Spot Fleet</strong> ‚Äì mix On-Demand and Spot; set baseline On-Demand, choose allocation strategy (lowest price/diversified/capacity-optimized) to hit target capacity at lower cost.</li>
  <li><strong>Lambda concurrency</strong> ‚Äì Regions allow bursts from hundreds up to tens of thousands; request service quota increases for sustained concurrency.</li>
</ul>

<hr />

    </article>
  </main>

  <div id="imageModal" class="image-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <button class="modal-nav modal-prev">&#8249;</button>
    <button class="modal-nav modal-next">&#8250;</button>
    <img id="modalImage" src="" alt="">
    <div id="modalCaption"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  const modalCaption = document.getElementById('modalCaption');
  const modalClose = document.querySelector('.modal-close');
  const modalPrev = document.querySelector('.modal-prev');
  const modalNext = document.querySelector('.modal-next');

  const SCALE_STEP = 0.2;
  const MIN_SCALE = 1;
  const MAX_SCALE = 3;

  let modalImages = [];
  let currentIndex = -1;
  let currentScale = MIN_SCALE;
  let translateX = 0;
  let translateY = 0;
  let isDragging = false;
  let isTouchDragging = false;
  let isPinching = false;
  let dragStartX = 0;
  let dragStartY = 0;
  let pinchStartDistance = 0;
  let pinchStartScale = MIN_SCALE;
  let transitionTimeout;

  function refreshModalImages() {
    modalImages = Array.from(document.querySelectorAll('.modal-trigger'));
  }

  function applyTransform(withTransition = false) {
    if (currentScale <= MIN_SCALE) {
      currentScale = MIN_SCALE;
      translateX = 0;
      translateY = 0;
    }

    if (transitionTimeout) {
      clearTimeout(transitionTimeout);
      transitionTimeout = null;
    }

    modalImg.style.transition = withTransition ? 'transform 0.15s ease' : 'none';
    modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
    modalImg.style.cursor = currentScale > MIN_SCALE
      ? (isDragging || isTouchDragging ? 'grabbing' : 'grab')
      : 'auto';

    if (withTransition) {
      transitionTimeout = setTimeout(() => {
        modalImg.style.transition = 'none';
      }, 160);
    }
  }

  function resetTransform() {
    currentScale = MIN_SCALE;
    translateX = 0;
    translateY = 0;
    applyTransform(false);
  }

  function getDistance(touch1, touch2) {
    return Math.hypot(
      touch1.clientX - touch2.clientX,
      touch1.clientY - touch2.clientY
    );
  }

  function openModalAtIndex(index) {
    refreshModalImages();

    if (!modalImages.length) {
      return;
    }

    if (index < 0) {
      index = modalImages.length - 1;
    } else if (index >= modalImages.length) {
      index = 0;
    }

    const target = modalImages[index];
    if (!target) {
      return;
    }

    currentIndex = index;
    const src = target.dataset.modalSrc || target.src;
    const caption = target.getAttribute('data-caption') || target.alt;

    modalImg.src = src;
    modalCaption.textContent = caption || '';
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    resetTransform();
  }

  function closeModal() {
    if (!modal.classList.contains('show')) {
      return;
    }
    modal.classList.remove('show');
    document.body.style.overflow = '';
    currentIndex = -1;
    isDragging = false;
    isTouchDragging = false;
    isPinching = false;
    resetTransform();
  }

  refreshModalImages();

  modalImg.addEventListener('dragstart', event => event.preventDefault());

  document.addEventListener('click', event => {
    const trigger = event.target.closest('.modal-trigger');
    if (!trigger) {
      return;
    }

    event.preventDefault();
    refreshModalImages();
    const index = modalImages.indexOf(trigger);
    openModalAtIndex(index > -1 ? index : 0);
  });

  modalClose?.addEventListener('click', closeModal);

  modal.addEventListener('click', event => {
    if (event.target === modal) {
      closeModal();
    }
  });

  document.addEventListener('keydown', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    switch (event.key) {
      case 'Escape':
        closeModal();
        break;
      case 'ArrowLeft':
        event.preventDefault();
        openModalAtIndex(currentIndex - 1);
        break;
      case 'ArrowRight':
        event.preventDefault();
        openModalAtIndex(currentIndex + 1);
        break;
      case '+':
      case '=':
        event.preventDefault();
        currentScale = Math.min(MAX_SCALE, currentScale + SCALE_STEP);
        applyTransform(true);
        break;
      case '-':
        event.preventDefault();
        currentScale = Math.max(MIN_SCALE, currentScale - SCALE_STEP);
        applyTransform(true);
        break;
      case '0':
        event.preventDefault();
        resetTransform();
        applyTransform(true);
        break;
      default:
        break;
    }
  });

  modal.addEventListener('wheel', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    event.preventDefault();
    const delta = event.deltaY > 0 ? -SCALE_STEP : SCALE_STEP;
    const nextScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, currentScale + delta));

    if (nextScale === currentScale) {
      return;
    }

    currentScale = nextScale;
    applyTransform(true);
  }, { passive: false });

  if (modalPrev) {
    modalPrev.addEventListener('click', event => {
      event.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex - 1);
    });
  }

  if (modalNext) {
    modalNext.addEventListener('click', event => {
      event.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex + 1);
    });
  }

  modalImg.addEventListener('mousedown', event => {
    if (!modal.classList.contains('show') || currentScale <= MIN_SCALE) {
      return;
    }

    event.preventDefault();
    isDragging = true;
    dragStartX = event.clientX;
    dragStartY = event.clientY;
    modalImg.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', event => {
    if (!isDragging) {
      return;
    }

    event.preventDefault();
    translateX += event.clientX - dragStartX;
    translateY += event.clientY - dragStartY;
    dragStartX = event.clientX;
    dragStartY = event.clientY;
    applyTransform(false);
  });

  document.addEventListener('mouseup', () => {
    if (!isDragging) {
      return;
    }
    isDragging = false;
    modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
  });

  modalImg.addEventListener('touchstart', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.touches.length === 1 && currentScale > MIN_SCALE) {
      event.preventDefault();
      isTouchDragging = true;
      dragStartX = event.touches[0].clientX;
      dragStartY = event.touches[0].clientY;
      modalImg.style.cursor = 'grabbing';
    } else if (event.touches.length === 2) {
      event.preventDefault();
      isTouchDragging = false;
      isPinching = true;
      pinchStartDistance = getDistance(event.touches[0], event.touches[1]);
      pinchStartScale = currentScale;
      modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
    }
  }, { passive: false });

  modalImg.addEventListener('touchmove', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (isPinching && event.touches.length === 2) {
      event.preventDefault();
      const distance = getDistance(event.touches[0], event.touches[1]);
      if (pinchStartDistance > 0) {
        const scaleRatio = distance / pinchStartDistance;
        currentScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, pinchStartScale * scaleRatio));
        applyTransform(false);
      }
    } else if (isTouchDragging && event.touches.length === 1) {
      event.preventDefault();
      translateX += event.touches[0].clientX - dragStartX;
      translateY += event.touches[0].clientY - dragStartY;
      dragStartX = event.touches[0].clientX;
      dragStartY = event.touches[0].clientY;
      applyTransform(false);
    }
  }, { passive: false });

  modalImg.addEventListener('touchend', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.touches.length === 0) {
      isTouchDragging = false;
      modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
    }

    if (event.touches.length < 2) {
      isPinching = false;
      pinchStartDistance = 0;
      pinchStartScale = currentScale;
    }
  });

  modalImg.addEventListener('touchcancel', () => {
    if (!modal.classList.contains('show')) {
      return;
    }

    isTouchDragging = false;
    isPinching = false;
    pinchStartDistance = 0;
    pinchStartScale = currentScale;
    modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
  });

  modal.addEventListener('touchend', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.target === modal && event.changedTouches.length === 1 && !isTouchDragging && !isPinching) {
      closeModal();
    }
  }, { passive: true });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-snippet-id]').forEach(caption => {
    const snippetId = caption.getAttribute('data-snippet-id');
    const snippetElement = document.getElementById(snippetId);

    if (snippetElement) {
      const content = snippetElement.textContent.replace(/"/g, '&quot;');
      caption.setAttribute('data-tooltip', content);
      caption.classList.add('diagram-caption');
    }
  });
});
</script>


  <!-- Floating Table of Contents -->
  <div id="floating-toc" class="floating-toc">
    <div class="toc-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
    </div>
    <div class="toc-content">
      <div class="toc-header">
        <span>Contents</span>
        <button class="toc-close" aria-label="Close table of contents">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <nav class="toc-nav" id="toc-nav">
        <!-- Generated by JavaScript -->
      </nav>
    </div>
  </div>

  <footer class="site-footer">
    <span>¬© 2025 glucolte ‚Ä¢ </span>
    <a href="https://github.com/gLuColte/glucolte.github.io">source</a>
  </footer>

  <script>
    // Dark mode functionality
    function initDarkMode() {
      const toggle = document.getElementById('dark-mode-toggle');
      const body = document.body;
      
      // Check for saved theme preference or default to light mode
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        body.setAttribute('data-theme', 'dark');
      }
      
      // Toggle dark mode
      if (toggle) {
        toggle.addEventListener('click', function() {
          const currentTheme = body.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          body.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      }
    }
    
    // Initialize dark mode immediately to prevent flash
    initDarkMode();
    
    // Initialize highlight.js and floating TOC after the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      hljs.highlightAll();
      
      // Floating TOC functionality - only show on sub-study pages
      const floatingToc = document.getElementById('floating-toc');
      const tocNav = document.getElementById('toc-nav');
      const tocClose = document.querySelector('.toc-close');
      
      // Check if we're on a sub-study page (not the main study index)
      const isSubStudyPage = window.location.pathname !== '/study/' && 
                            window.location.pathname !== '/study' && 
                            window.location.pathname.startsWith('/study/');
      
      if (floatingToc && tocNav && isSubStudyPage) {
        // Generate TOC from headings
        function generateTOC() {
          const headings = document.querySelectorAll('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6');
          if (headings.length === 0) {
            floatingToc.style.display = 'none';
            return;
          }
          
          const tocList = document.createElement('ul');
          let currentLevel = 0;
          let currentList = tocList;
          const listStack = [tocList];
          
          headings.forEach((heading, index) => {
            const level = parseInt(heading.tagName.charAt(1));
            const id = heading.id || `heading-${index}`;
            
            // Ensure heading has an ID
            if (!heading.id) {
              heading.id = id;
            }
            
            // Create list item
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = `#${id}`;
            link.textContent = heading.textContent.trim();
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const targetElement = document.getElementById(id);
              if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Close TOC after clicking
                floatingToc.classList.remove('toc-open');
              }
            });
            
            listItem.appendChild(link);
            
            // Handle nesting
            if (level > currentLevel) {
              // Go deeper
              for (let i = currentLevel; i < level; i++) {
                const newList = document.createElement('ul');
                currentList.appendChild(newList);
                listStack.push(newList);
                currentList = newList;
              }
            } else if (level < currentLevel) {
              // Go shallower
              for (let i = currentLevel; i > level; i--) {
                listStack.pop();
                currentList = listStack[listStack.length - 1];
              }
            }
            
            currentList.appendChild(listItem);
            currentLevel = level;
          });
          
          tocNav.appendChild(tocList);
        }
        
        // Generate the TOC
        generateTOC();
        
        // Handle close button
        if (tocClose) {
          tocClose.addEventListener('click', function() {
            floatingToc.classList.remove('toc-open');
          });
        }
        
        // Handle click on icon to toggle
        const tocIcon = document.querySelector('.toc-icon');
        if (tocIcon) {
          tocIcon.addEventListener('click', function() {
            floatingToc.classList.toggle('toc-open');
          });
        }
        
        // Active section highlighting
        function updateActiveSection() {
          const headings = document.querySelectorAll('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6');
          const tocLinks = tocNav.querySelectorAll('a');
          
          // Remove active class from all links
          tocLinks.forEach(link => link.classList.remove('active'));
          
          // Find the current section
          let currentHeading = null;
          const scrollPosition = window.scrollY + 100; // Offset for better UX
          
          for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            const headingTop = heading.offsetTop;
            
            if (headingTop <= scrollPosition) {
              currentHeading = heading;
              break;
            }
          }
          
          // Add active class to current section
          if (currentHeading) {
            const activeLink = tocNav.querySelector(`a[href="#${currentHeading.id}"]`);
            if (activeLink) {
              activeLink.classList.add('active');
            }
          }
        }
        
        // Update active section on scroll
        let scrollTimeout;
        window.addEventListener('scroll', function() {
          if (scrollTimeout) {
            clearTimeout(scrollTimeout);
          }
          scrollTimeout = setTimeout(updateActiveSection, 10);
        });
        
        // Initial update
        updateActiveSection();
      } else if (floatingToc && !isSubStudyPage) {
        // Hide floating TOC on main study page
        floatingToc.style.display = 'none';
      }
      
      // Legacy TOC functionality (for existing markdown TOCs)
      const toc = document.querySelector('#markdown-toc');
      if (toc) {
        // Hide the floating TOC if there's already a markdown TOC
        if (floatingToc) {
          floatingToc.style.display = 'none';
        }
        
        // Create TOC container with header
        const tocContainer = document.createElement('div');
        tocContainer.className = 'toc-container';
        tocContainer.style.cssText = `
          background: #f8fafc;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 16px;
          margin: 20px 0;
          position: relative;
        `;
        
        // Add TOC header
        const tocHeader = document.createElement('h3');
        tocHeader.textContent = 'Table of Contents';
        tocHeader.style.cssText = `
          margin: 0 0 12px 0;
          font-size: 16px;
          font-weight: 600;
          color: #374151;
        `;
        
        // Add back to top button
        const backToTopBtn = document.createElement('button');
        backToTopBtn.textContent = '‚Üë Top';
        backToTopBtn.style.cssText = `
          position: absolute;
          top: 12px;
          right: 12px;
          background: #ffffff;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          padding: 4px 8px;
          font-size: 12px;
          cursor: pointer;
          color: #6b7280;
          transition: all 0.2s ease;
        `;
        
        // Add hover effect for back to top button
        backToTopBtn.addEventListener('mouseenter', function() {
          this.style.background = '#f3f4f6';
          this.style.color = '#374151';
        });
        
        backToTopBtn.addEventListener('mouseleave', function() {
          this.style.background = '#ffffff';
          this.style.color = '#6b7280';
        });
        
        // Back to top functionality
        backToTopBtn.addEventListener('click', function() {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Style the TOC list
        toc.style.cssText = `
          margin: 0;
          padding: 0;
          font-size: 14px;
          line-height: 1.5;
        `;
        
        // Insert header and button into container
        tocContainer.appendChild(tocHeader);
        tocContainer.appendChild(backToTopBtn);
        tocContainer.appendChild(toc);
        
        // Replace the original TOC with the new container
        toc.parentNode.insertBefore(tocContainer, toc);
        tocContainer.appendChild(toc);
        
        // Add smooth scrolling to TOC links
        const tocLinks = toc.querySelectorAll('a');
        tocLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: 'smooth' });
            }
          });
        });
      }
    });
  </script>
</body>
</html>
