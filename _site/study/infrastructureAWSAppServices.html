<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AWS Application Services ¬∑ glucolte</title>
  <meta name="description" content="notes ‚Ä¢ principles ‚Ä¢ systems">
  <link rel="stylesheet" href="/assets/style.css">
  <link rel="stylesheet" href="/assets/study.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AWS Application Services | glucolte</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="AWS Application Services" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="notes ‚Ä¢ principles ‚Ä¢ systems" />
<meta property="og:description" content="notes ‚Ä¢ principles ‚Ä¢ systems" />
<link rel="canonical" href="http://localhost:4000/study/infrastructureAWSAppServices" />
<meta property="og:url" content="http://localhost:4000/study/infrastructureAWSAppServices" />
<meta property="og:site_name" content="glucolte" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AWS Application Services" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"notes ‚Ä¢ principles ‚Ä¢ systems","headline":"AWS Application Services","url":"http://localhost:4000/study/infrastructureAWSAppServices"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="site-header">
  <a class="brand" href="/">glucolte</a>
  <nav class="nav">
    <a href="/principles">principles</a>
    <a href="/rules">rules</a>
    <a href="/stretches">stretches</a>
    <a href="/study/">study</a>
    <a href="/projects/">projects</a>
    <a href="/setup/">setup</a>
  </nav>
  <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
    <svg class="sun-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
    <svg class="moon-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>
</header>


  <main class="container">
    <article class="content">
      <h2 id="section-1-amazon-ecs">1. Amazon ECS</h2>

<p>Elastic Container Service orchestrates Docker containers using task definitions and services while taking care of placement and health checks. Know which construct holds IAM roles, CPU, or restart logic‚Äîexam questions love mapping requirements to ECS components.</p>

<h3 id="section-1-1-ecs-core">1.1 Core Concepts</h3>

<ul>
  <li><strong>Task definition</strong> ‚Äì describes one or more containers, CPU/memory, networking mode, IAM task role, port mappings, command/entrypoint, and environment variables.</li>
  <li><strong>Service</strong> ‚Äì runs a desired count of tasks, handles restarts, load balancer registration, and placement strategies.</li>
  <li><strong>Task role</strong> ‚Äì IAM permissions inherited by every container in the task.</li>
</ul>

<h3 id="section-1-2-ecs-launch">1.2 Launch Types</h3>

<table class="study-table">
<thead>
<tr>
<th>Launch Type</th>
<th>When to Use</th>
<th>Operational Model</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>EC2</strong></td>
<td>Need control over servers, spot/reserved pricing, or local instance storage.</td>
<td>Provision and patch the EC2 instances; ECS schedules tasks onto them.</td>
</tr>
<tr>
<td><strong>Fargate</strong></td>
<td>Serverless containers, per-second billing, small/bursty workloads, fast scale.</td>
<td>AWS manages the infrastructure; each task receives an ENI inside your VPC.</td>
</tr>
<tr>
<td><strong>ECS Anywhere</strong></td>
<td>Hybrid/on-premises clusters while reusing ECS control plane.</td>
<td>Install the ECS Anywhere agent on customer-managed hardware.</td>
</tr>
</tbody>
</table>

<hr />

<h2 id="section-2-amazon-eks">2. Amazon EKS</h2>

<p>Managed Kubernetes service with multi-AZ control plane and integration into AWS networking and storage.</p>

<ul>
  <li>Control plane nodes run in an AWS-managed VPC across multiple AZs with etcd replication. AWS patches/monitors the API servers and etcd so you only worry about worker nodes.</li>
  <li>Worker nodes (self-managed, managed node groups, or Fargate pods) live in your VPC; ENIs are injected into your subnets so SGs/NACLs behave like standard EC2 instances.</li>
  <li>Storage add-ons (EBS/EFS/FSx CSI drivers) provide persistent volumes; load balancers map to ALB/NLB via controllers. IAM roles for service accounts (IRSA) integrate pods with IAM.</li>
  <li>EKS Anywhere/EKS Distro extend clusters on-premises for hybrid edge deployments.</li>
</ul>

<hr />

<h2 id="section-3-amazon-sns">3. Amazon SNS</h2>

<p>Pub/sub messaging service for fan-out scenarios.</p>

<ul>
  <li>Topics receive up to 256 KB payloads and replicate messages to subscribers (HTTP/S, email, SMS, Lambda, SQS, mobile push, Kinesis, Firehose, etc.).</li>
  <li>Delivery is push-based with retries/backoff; CloudWatch metrics capture success/failure per protocol. Enable message filtering to reduce downstream noise.</li>
  <li>Encrypt topics with SSE and control access through topic policies so other accounts or services can publish/subscribe.</li>
  <li>Typical pattern: one publish triggers multiple downstream workflows‚Äîorder events can update CRMs, notify warehouses, and text customers simultaneously.</li>
</ul>

<hr />

<h2 id="section-4-amazon-sqs">4. Amazon SQS</h2>

<p>Fully managed queueing service for decoupling producers/consumers.</p>

<h3 id="section-4-1-queue-behavior">4.1 Queue Behavior</h3>

<ul>
  <li>Producers send messages up to 256 KB; consumers poll for messages (optionally long-poll to cut empty responses).</li>
  <li><strong>Visibility timeout</strong> prevents other consumers from seeing a message while it is being processed. If the consumer fails to delete the message before timeout, the message becomes visible again‚Äîset the timeout slightly longer than normal processing to avoid duplicates.</li>
  <li><strong>Dead-letter queues (DLQ)</strong> capture poison messages after <code class="language-plaintext highlighter-rouge">maxReceiveCount</code> attempts so bad payloads do not clog the primary queue.</li>
  <li>Supports server-side encryption, VPC endpoints, and scaling ASGs based on queue depth (watch <code class="language-plaintext highlighter-rouge">ApproximateNumberOfMessagesVisible</code>).</li>
</ul>

<h3 id="section-4-2-queue-types">4.2 Queue Types</h3>

<table class="study-table">
<thead>
<tr>
<th>Type</th>
<th>Ordering</th>
<th>Throughput</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Standard</strong></td>
<td>Best-effort ordering; at-least-once delivery.</td>
<td>Unlimited TPS.</td>
<td>General messaging, fan-out from SNS.</td>
</tr>
<tr>
<td><strong>FIFO</strong></td>
<td>Exactly-once processing, strict ordering (queue name ends with `.fifo`).</td>
<td>Up to 3,000 msgs/sec with batching (300 without).</td>
<td>Workflows requiring ordered events or financial transactions.</td>
</tr>
</tbody>
</table>

<h3 id="section-4-3-queue-extras">4.3 Extras</h3>

<ul>
  <li><strong>Extended Client Library</strong> ‚Äì stores payloads &gt;256 KB in S3, leaving a pointer in the queue. Use for image/document pipelines without rolling custom chunking.</li>
  <li><strong>Delay queues</strong> ‚Äì postpone delivery (0‚Äì15 minutes). Not supported on FIFO queues. Handy for reminders, scheduled notifications, or staggering retries.</li>
  <li><strong>Pricing</strong> ‚Äì billed per request (1 request = up to 10 messages/64 KB) plus optional long polling. Long polling lowers cost by reducing empty responses.</li>
</ul>

<hr />

<h2 id="section-5-amazon-mq">5. Amazon MQ</h2>

<p>Managed Apache ActiveMQ broker for legacy protocols (AMQP, MQTT, OpenWire, JMS, STOMP).</p>

<ul>
  <li>Deploys inside a VPC (single instance or HA pair). You manage network access via security groups.</li>
  <li>Ideal for lift-and-shift from on-premises brokers when SNS/SQS APIs are not compatible.</li>
</ul>

<hr />

<h2 id="section-6-aws-lambda">6. AWS Lambda</h2>

<h3 id="section-6-1-execution-model">6.1 Execution Model</h3>

<ul>
  <li>Package up to 50 MB (zipped) / 250 MB (unzipped) with code + dependencies. Upload via console/CLI/CI or container images.</li>
  <li>Configure runtime (Node.js, Python, Java, .NET, custom Runtime API), handler, memory (128 MB‚Äì10,240 MB), environment variables, execution role, and optional layers.</li>
  <li><code class="language-plaintext highlighter-rouge">/tmp</code> scratch space (512 MB) or mount EFS for larger persistent storage across invocations.</li>
  <li>Billed per request + ms of execution (memory size influences cost); max 900 seconds per invoke.</li>
  <li>CloudWatch Logs, metrics, and AWS X-Ray capture invocation counts, durations, cold starts, and downstream traces.</li>
</ul>

<h3 id="section-6-2-networking">6.2 Networking</h3>

<ul>
  <li><strong>Public networking</strong> ‚Äì Lambda runs on AWS shared infrastructure with internet egress to public services (perfect for hitting AWS public APIs/SaaS endpoints).</li>
  <li><strong>VPC networking</strong> ‚Äì attach Lambda to private subnets; AWS creates ENIs for each subnet/security group combo (initial cold attach can take ~90s). Use NAT Gateway or VPC endpoints for outbound access. Required for RDS, Redshift, or on-prem targets.</li>
</ul>

<h3 id="section-6-3-invocation">6.3 Invocation Patterns</h3>

<ul>
  <li><strong>Synchronous</strong> ‚Äì caller waits for response (API Gateway, CLI invoke). Caller handles retries/timeouts; errors bubble back immediately.</li>
  <li><strong>Asynchronous</strong> ‚Äì Lambda queues the event and retries up to two times before sending to DLQ/SNS/EventBridge; write idempotent code because events may re-run.</li>
  <li><strong>Event source mappings</strong> ‚Äì poll streams/queues (Kinesis, DynamoDB Streams, SQS) and push batches to Lambda; configure batch size, parallelism, and bisect retry, all using the function‚Äôs execution role.</li>
</ul>

<h3 id="section-6-4-versions-aliases">6.4 Versions &amp; Aliases</h3>

<ul>
  <li>Publishing creates immutable versions with unique ARNs; <code class="language-plaintext highlighter-rouge">$LATEST</code> is mutable.</li>
  <li>Aliases (e.g., <code class="language-plaintext highlighter-rouge">Dev</code>, <code class="language-plaintext highlighter-rouge">Prod</code>) point to versions and can route percent-based traffic between two versions (canary). <code class="language-plaintext highlighter-rouge">$LATEST</code> cannot be used for alias routing.</li>
</ul>

<h3 id="section-6-5-env-context">6.5 Environment, Context, and Layers</h3>

<ul>
  <li><strong>Environment variables</strong> ‚Äì key/value pairs per version; optionally encrypted with KMS.</li>
  <li><strong>Execution context</strong> ‚Äì runtime + extensions + function code kept warm for reuse; cold starts load code from S3. Provisioned Concurrency pre-warms contexts.</li>
  <li><strong>Layers</strong> ‚Äì shared <code class="language-plaintext highlighter-rouge">/opt</code> bundles for libraries or runtimes, shrinking deployment packages.</li>
  <li><strong>Container images</strong> ‚Äì package runtimes via ECR images with Lambda Runtime API for consistent environments.</li>
</ul>

<h3 id="section-6-6-handler">6.6 Function Handler Lifecycle</h3>

<div class="image-wrapper">
  <img src="./assets/lambda_lifecycle.png" alt="lambda_lifecycle" class="modal-trigger" data-caption="üß© Lambda Lifecycle" />
  <div class="diagram-caption" data-snippet-id="lambda_lifecycle">
    üß© Lambda Lifecycle
  </div>
  <script type="text/plain" id="lambda_lifecycle">
@startuml
title How applications interact with storage types

actor Application

participant "File System\n(NFS/SMB/Lustre)" as FILE
participant "Block Device\n(EBS)" as BLOCK
participant "Object Store\n(S3 API)" as OBJECT
participant "Physical Disk Blocks" as DISK

Application -> BLOCK: Read/write blocks\n(LBA addresses, sectors)
BLOCK -> DISK: Map to disk blocks

Application -> FILE: Read/write files\n(open/read/write/close)
FILE -> DISK: Convert to block operations

Application -> OBJECT: PUT/GET object\n(Key + Metadata)
OBJECT -> DISK: Store data as objects

@enduml
  </script>
</div>
<hr />

<h2 id="section-7-api-gateway">7. API Gateway</h2>

<p>Managed front door for REST, HTTP, and WebSocket APIs. Think of it as a programmable HTTPS fabric that centralizes auth, throttling, caching, and protocol translation.</p>

<h3 id="section-7-1-structure">7.1 Structure</h3>

<ul>
  <li>Handles authorization (IAM, Cognito, Lambda authorizers), throttling, caching, CORS, request/response transformation.</li>
  <li>Endpoint types: <strong>Edge-Optimized</strong> (CloudFront PoPs), <strong>Regional</strong>, <strong>Private</strong> (via interface endpoints).</li>
  <li>Deploy APIs to <strong>stages</strong> (e.g., dev/test/prod). Each stage has its own URL, config, cache, and canary release settings. Changes go live only after deployment to a stage.</li>
  <li>Resource path: <code class="language-plaintext highlighter-rouge">https://{restapi-id}.execute-api.{region}.amazonaws.com/{stage}/{resource}</code>.</li>
</ul>

<h3 id="section-7-2-integrations">7.2 Integrations</h3>

<ul>
  <li>Method request ‚Üí integration request ‚Üí integration response ‚Üí method response. Knowing where mapping templates apply is key to debugging transformations.</li>
  <li>Integration types:
    <ul>
      <li><strong>MOCK</strong> ‚Äì testing without backends.</li>
      <li><strong>HTTP / HTTP Proxy</strong> ‚Äì invoke HTTP endpoints; proxy passes through unmodified payloads.</li>
      <li><strong>AWS / AWS_PROXY</strong> ‚Äì call AWS services; Lambda proxy sends entire request context to Lambda.</li>
    </ul>
  </li>
  <li>Use mapping templates (Velocity Template Language) to reshape payloads (e.g., REST-to-SOAP translation, header mapping).</li>
</ul>

<h3 id="section-7-3-operations">7.3 Operations</h3>

<ul>
  <li>Errors: <code class="language-plaintext highlighter-rouge">400</code> (bad request), <code class="language-plaintext highlighter-rouge">403</code> (access denied), <code class="language-plaintext highlighter-rouge">429</code> (throttled), <code class="language-plaintext highlighter-rouge">502/503/504</code> (integration failures/timeouts). Map these to upstream or client issues quickly.</li>
  <li>Caching per stage (500 MB‚Äì237 GB, TTL 0‚Äì3600 seconds). Cache invalidation is manual‚Äîconsider <code class="language-plaintext highlighter-rouge">InvalidateCache</code> or redeploy when data changes.</li>
</ul>

<hr />

<h2 id="section-8-event-driven">8. Event-Driven Services</h2>

<h3 id="section-8-1-eventbridge">8.1 EventBridge (CloudWatch Events)</h3>

<ul>
  <li>Event bus + rules service: ‚ÄúIf X happens or at time Y, do Z.‚Äù EventBridge consumes events from AWS services, SaaS partners, or custom apps and routes them to targets (Lambda, Step Functions, Kinesis, API destinations, etc.).</li>
  <li>Supports default, partner, and custom event buses; CloudWatch Events only exposed the default bus. Multi-bus design keeps noisy teams isolated.</li>
  <li>Two rule types: <strong>Event pattern</strong> (match JSON fields) and <strong>Schedule</strong> (cron/<code class="language-plaintext highlighter-rouge">rate()</code> expressions). Rules can send the same event to multiple targets with JSON input transformations.</li>
  <li>Use resource policies to share buses across accounts/organizations and archive/replay events for troubleshooting.</li>
</ul>

<h3 id="section-8-2-step-functions">8.2 AWS Step Functions</h3>

<ul>
  <li>Orchestrates long-running serverless workflows using Amazon States Language (JSON). Ideal when Lambda chaining becomes messy, or when processes exceed Lambda‚Äôs 15-minute limit.</li>
  <li>State machine primitives: <code class="language-plaintext highlighter-rouge">Task</code>, <code class="language-plaintext highlighter-rouge">Choice</code>, <code class="language-plaintext highlighter-rouge">Wait</code>, <code class="language-plaintext highlighter-rouge">Parallel</code>, <code class="language-plaintext highlighter-rouge">Map</code>, <code class="language-plaintext highlighter-rouge">Succeed</code>, <code class="language-plaintext highlighter-rouge">Fail</code>. Each state can define retry/catch blocks for resiliency.</li>
  <li>Standard workflows keep state up to 1 year and provide exactly-once semantics; Express workflows favor millions of short executions per second at lower cost but best-effort ordering.</li>
  <li>Integrates with Lambda, ECS/Fargate, Batch, DynamoDB, SNS/SQS, Glue, EMR, SageMaker, API Gateway, Step Functions callbacks, and more. IAM roles govern which services each state can call.</li>
  <li>Visual workflow designer + CloudWatch execution history make debugging easier than manual Lambda pipelines.</li>
</ul>

<h3 id="section-8-3-swf">8.3 AWS SWF</h3>

<ul>
  <li>Predecessor to Step Functions; still used when workflows require custom deciders, worker heartbeats, external signals, child workflows, or deep Mechanical Turk integration.</li>
  <li>Provides activity task/worker model with Amazon Flow Framework support. You own the worker code and can pause/resume human workflows mid-flight.</li>
  <li>Exam tip: choose SWF when you need centralized state tracking with human intervention or when migrating legacy Flow Framework workloads.</li>
</ul>

<hr />

<h2 id="section-9-content-media">9. Content &amp; Media Services</h2>

<h3 id="section-9-1-mechanical-turk">9.1 Amazon Mechanical Turk</h3>

<ul>
  <li>Crowdsourcing marketplace for Human Intelligence Tasks (HITs).</li>
  <li>Requesters post tasks with qualifications; workers complete tasks for pay per HIT. APIs manage HIT lifecycle programmatically.</li>
  <li>Useful for labeling, moderation, surveys, sentiment analysis, or any workflow requiring human judgment before automation.</li>
  <li>Often paired with S3 + Lambda pipelines where MTurk handles edge cases (e.g., ambiguous images) before data re-enters automated steps.</li>
</ul>

<h3 id="section-9-2-mediaconvert">9.2 AWS Elemental MediaConvert (vs. Elastic Transcoder)</h3>

<ul>
  <li>File-based video transcoding: pull from S3, process jobs, push outputs back to S3.</li>
  <li>MediaConvert is the modern service (more codecs, parallelism, EventBridge notifications, reserved pricing). Elastic Transcoder is legacy but supports WebM/Animated GIF/MP3/FLAC/Vorbis/WAV.</li>
</ul>

<hr />

<h2 id="section-10-iot-edge">10. IoT &amp; Edge</h2>

<h3 id="section-10-1-iot-core">10.1 AWS IoT Core</h3>

<ul>
  <li>Connect millions of IoT devices using MQTT/HTTP, manage device shadows (cloud-side JSON twins), and trigger rules to Lambda/Kinesis/etc.</li>
  <li>Device shadows buffer desired/reported state so applications interact reliably even with intermittent connectivity.</li>
</ul>

<h3 id="section-10-2-greengrass">10.2 AWS IoT Greengrass</h3>

<ul>
  <li>Extends AWS compute/messaging/ML to edge devices; run Lambda functions, containers, data streams locally, and sync to the cloud when connectivity returns.</li>
  <li>Deploy Greengrass cores on gateways; devices keep operating locally during network loss.</li>
</ul>

<hr />

<h2 id="section-11-developer-tooling">11. Developer Tooling</h2>

<h3 id="section-11-1-sam">11.1 AWS Serverless Application Model (SAM)</h3>

<ul>
  <li>Open-source framework that extends CloudFormation with serverless-specific resources and transforms.</li>
  <li>SAM template = infrastructure-as-code for S3/CloudFront (frontend assets), API Gateway, Lambda, DynamoDB, etc.</li>
  <li>SAM CLI ‚Äì build/test locally, package artifacts, and deploy stacks.</li>
  <li>Full serverless app flow: host static assets on S3/CloudFront, expose APIs via API Gateway, run compute on Lambda, state on DynamoDB.</li>
</ul>

<hr />

<h2 id="section-12-exam-reminders">12. Exam Reminders</h2>

<ul>
  <li><strong>API Gateway caching</strong> ‚Äì enabled per stage/method; TTL 0‚Äì3600 seconds; incurs hourly charge but dramatically reduces backend load. Invalidate caches after major data changes.</li>
  <li><strong>ElastiCache refresher</strong> ‚Äì Redis offers persistence, pub/sub, clustering, and transactions; Memcached is a simple multi-threaded sharded cache with no replication. Choose accordingly.</li>
  <li><strong>Forward proxy vs NAT Gateway</strong> ‚Äì forward proxies enforce egress policies (DLP/IDS/IPS/caching) for specific clients; NAT Gateway simply translates private ‚Üí public IP for egress and cannot inspect payloads.</li>
  <li><strong>Traffic Mirroring</strong> ‚Äì replicate ENI traffic to monitoring appliances for deep packet analysis without affecting production flows.</li>
  <li><strong>IoT Core</strong> ‚Äì device gateway + rules engine; integrates with Lambda/Kinesis and handles offline device state via shadows.</li>
  <li><strong>AppSync</strong> ‚Äì serverless GraphQL with real-time subscriptions, offline sync, and resolvers into DynamoDB, Lambda, RDS, OpenSearch, or HTTP endpoints.</li>
  <li><strong>Contact-center AI stack</strong> ‚Äì Amazon Lex (IVR bots), Polly (text-to-speech), Transcribe (call recording), and Comprehend (NLP sentiment) combine for contact center analytics.</li>
</ul>

<hr />

    </article>
  </main>

  <div id="imageModal" class="image-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <button class="modal-nav modal-prev">&#8249;</button>
    <button class="modal-nav modal-next">&#8250;</button>
    <img id="modalImage" src="" alt="">
    <div id="modalCaption"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  const modalCaption = document.getElementById('modalCaption');
  const modalClose = document.querySelector('.modal-close');
  const modalPrev = document.querySelector('.modal-prev');
  const modalNext = document.querySelector('.modal-next');

  const SCALE_STEP = 0.2;
  const MIN_SCALE = 1;
  const MAX_SCALE = 3;

  let modalImages = [];
  let currentIndex = -1;
  let currentScale = MIN_SCALE;
  let translateX = 0;
  let translateY = 0;
  let isDragging = false;
  let isTouchDragging = false;
  let isPinching = false;
  let dragStartX = 0;
  let dragStartY = 0;
  let pinchStartDistance = 0;
  let pinchStartScale = MIN_SCALE;
  let transitionTimeout;

  function refreshModalImages() {
    modalImages = Array.from(document.querySelectorAll('.modal-trigger'));
  }

  function applyTransform(withTransition = false) {
    if (currentScale <= MIN_SCALE) {
      currentScale = MIN_SCALE;
      translateX = 0;
      translateY = 0;
    }

    if (transitionTimeout) {
      clearTimeout(transitionTimeout);
      transitionTimeout = null;
    }

    modalImg.style.transition = withTransition ? 'transform 0.15s ease' : 'none';
    modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
    modalImg.style.cursor = currentScale > MIN_SCALE
      ? (isDragging || isTouchDragging ? 'grabbing' : 'grab')
      : 'auto';

    if (withTransition) {
      transitionTimeout = setTimeout(() => {
        modalImg.style.transition = 'none';
      }, 160);
    }
  }

  function resetTransform() {
    currentScale = MIN_SCALE;
    translateX = 0;
    translateY = 0;
    applyTransform(false);
  }

  function getDistance(touch1, touch2) {
    return Math.hypot(
      touch1.clientX - touch2.clientX,
      touch1.clientY - touch2.clientY
    );
  }

  function openModalAtIndex(index) {
    refreshModalImages();

    if (!modalImages.length) {
      return;
    }

    if (index < 0) {
      index = modalImages.length - 1;
    } else if (index >= modalImages.length) {
      index = 0;
    }

    const target = modalImages[index];
    if (!target) {
      return;
    }

    currentIndex = index;
    const src = target.dataset.modalSrc || target.src;
    const caption = target.getAttribute('data-caption') || target.alt;

    modalImg.src = src;
    modalCaption.textContent = caption || '';
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    resetTransform();
  }

  function closeModal() {
    if (!modal.classList.contains('show')) {
      return;
    }
    modal.classList.remove('show');
    document.body.style.overflow = '';
    currentIndex = -1;
    isDragging = false;
    isTouchDragging = false;
    isPinching = false;
    resetTransform();
  }

  refreshModalImages();

  modalImg.addEventListener('dragstart', event => event.preventDefault());

  document.addEventListener('click', event => {
    const trigger = event.target.closest('.modal-trigger');
    if (!trigger) {
      return;
    }

    event.preventDefault();
    refreshModalImages();
    const index = modalImages.indexOf(trigger);
    openModalAtIndex(index > -1 ? index : 0);
  });

  modalClose?.addEventListener('click', closeModal);

  modal.addEventListener('click', event => {
    if (event.target === modal) {
      closeModal();
    }
  });

  document.addEventListener('keydown', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    switch (event.key) {
      case 'Escape':
        closeModal();
        break;
      case 'ArrowLeft':
        event.preventDefault();
        openModalAtIndex(currentIndex - 1);
        break;
      case 'ArrowRight':
        event.preventDefault();
        openModalAtIndex(currentIndex + 1);
        break;
      case '+':
      case '=':
        event.preventDefault();
        currentScale = Math.min(MAX_SCALE, currentScale + SCALE_STEP);
        applyTransform(true);
        break;
      case '-':
        event.preventDefault();
        currentScale = Math.max(MIN_SCALE, currentScale - SCALE_STEP);
        applyTransform(true);
        break;
      case '0':
        event.preventDefault();
        resetTransform();
        applyTransform(true);
        break;
      default:
        break;
    }
  });

  modal.addEventListener('wheel', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    event.preventDefault();
    const delta = event.deltaY > 0 ? -SCALE_STEP : SCALE_STEP;
    const nextScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, currentScale + delta));

    if (nextScale === currentScale) {
      return;
    }

    currentScale = nextScale;
    applyTransform(true);
  }, { passive: false });

  if (modalPrev) {
    modalPrev.addEventListener('click', event => {
      event.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex - 1);
    });
  }

  if (modalNext) {
    modalNext.addEventListener('click', event => {
      event.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex + 1);
    });
  }

  modalImg.addEventListener('mousedown', event => {
    if (!modal.classList.contains('show') || currentScale <= MIN_SCALE) {
      return;
    }

    event.preventDefault();
    isDragging = true;
    dragStartX = event.clientX;
    dragStartY = event.clientY;
    modalImg.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', event => {
    if (!isDragging) {
      return;
    }

    event.preventDefault();
    translateX += event.clientX - dragStartX;
    translateY += event.clientY - dragStartY;
    dragStartX = event.clientX;
    dragStartY = event.clientY;
    applyTransform(false);
  });

  document.addEventListener('mouseup', () => {
    if (!isDragging) {
      return;
    }
    isDragging = false;
    modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
  });

  modalImg.addEventListener('touchstart', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.touches.length === 1 && currentScale > MIN_SCALE) {
      event.preventDefault();
      isTouchDragging = true;
      dragStartX = event.touches[0].clientX;
      dragStartY = event.touches[0].clientY;
      modalImg.style.cursor = 'grabbing';
    } else if (event.touches.length === 2) {
      event.preventDefault();
      isTouchDragging = false;
      isPinching = true;
      pinchStartDistance = getDistance(event.touches[0], event.touches[1]);
      pinchStartScale = currentScale;
      modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
    }
  }, { passive: false });

  modalImg.addEventListener('touchmove', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (isPinching && event.touches.length === 2) {
      event.preventDefault();
      const distance = getDistance(event.touches[0], event.touches[1]);
      if (pinchStartDistance > 0) {
        const scaleRatio = distance / pinchStartDistance;
        currentScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, pinchStartScale * scaleRatio));
        applyTransform(false);
      }
    } else if (isTouchDragging && event.touches.length === 1) {
      event.preventDefault();
      translateX += event.touches[0].clientX - dragStartX;
      translateY += event.touches[0].clientY - dragStartY;
      dragStartX = event.touches[0].clientX;
      dragStartY = event.touches[0].clientY;
      applyTransform(false);
    }
  }, { passive: false });

  modalImg.addEventListener('touchend', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.touches.length === 0) {
      isTouchDragging = false;
      modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
    }

    if (event.touches.length < 2) {
      isPinching = false;
      pinchStartDistance = 0;
      pinchStartScale = currentScale;
    }
  });

  modalImg.addEventListener('touchcancel', () => {
    if (!modal.classList.contains('show')) {
      return;
    }

    isTouchDragging = false;
    isPinching = false;
    pinchStartDistance = 0;
    pinchStartScale = currentScale;
    modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
  });

  modal.addEventListener('touchend', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.target === modal && event.changedTouches.length === 1 && !isTouchDragging && !isPinching) {
      closeModal();
    }
  }, { passive: true });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-snippet-id]').forEach(caption => {
    const snippetId = caption.getAttribute('data-snippet-id');
    const snippetElement = document.getElementById(snippetId);

    if (snippetElement) {
      const content = snippetElement.textContent.replace(/"/g, '&quot;');
      caption.setAttribute('data-tooltip', content);
      caption.classList.add('diagram-caption');
    }
  });
});
</script>


  <!-- Floating Table of Contents -->
  <div id="floating-toc" class="floating-toc">
    <div class="toc-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
    </div>
    <div class="toc-content">
      <div class="toc-header">
        <span>Contents</span>
        <button class="toc-close" aria-label="Close table of contents">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <nav class="toc-nav" id="toc-nav">
        <!-- Generated by JavaScript -->
      </nav>
    </div>
  </div>

  <footer class="site-footer">
    <span>¬© 2025 glucolte ‚Ä¢ </span>
    <a href="https://github.com/gLuColte/glucolte.github.io">source</a>
  </footer>

  <script>
    // Dark mode functionality
    function initDarkMode() {
      const toggle = document.getElementById('dark-mode-toggle');
      const body = document.body;
      
      // Check for saved theme preference or default to light mode
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        body.setAttribute('data-theme', 'dark');
      }
      
      // Toggle dark mode
      if (toggle) {
        toggle.addEventListener('click', function() {
          const currentTheme = body.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          body.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      }
    }
    
    // Initialize dark mode immediately to prevent flash
    initDarkMode();
    
    // Initialize highlight.js and floating TOC after the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      hljs.highlightAll();
      
      // Floating TOC functionality - only show on sub-study pages
      const floatingToc = document.getElementById('floating-toc');
      const tocNav = document.getElementById('toc-nav');
      const tocClose = document.querySelector('.toc-close');
      
      // Check if we're on a sub-study page (not the main study index)
      const isSubStudyPage = window.location.pathname !== '/study/' && 
                            window.location.pathname !== '/study' && 
                            window.location.pathname.startsWith('/study/');
      
      if (floatingToc && tocNav && isSubStudyPage) {
        // Generate TOC from headings
        function generateTOC() {
          const headings = document.querySelectorAll('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6');
          if (headings.length === 0) {
            floatingToc.style.display = 'none';
            return;
          }
          
          const tocList = document.createElement('ul');
          let currentLevel = 0;
          let currentList = tocList;
          const listStack = [tocList];
          
          headings.forEach((heading, index) => {
            const level = parseInt(heading.tagName.charAt(1));
            const id = heading.id || `heading-${index}`;
            
            // Ensure heading has an ID
            if (!heading.id) {
              heading.id = id;
            }
            
            // Create list item
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = `#${id}`;
            link.textContent = heading.textContent.trim();
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const targetElement = document.getElementById(id);
              if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Close TOC after clicking
                floatingToc.classList.remove('toc-open');
              }
            });
            
            listItem.appendChild(link);
            
            // Handle nesting
            if (level > currentLevel) {
              // Go deeper
              for (let i = currentLevel; i < level; i++) {
                const newList = document.createElement('ul');
                currentList.appendChild(newList);
                listStack.push(newList);
                currentList = newList;
              }
            } else if (level < currentLevel) {
              // Go shallower
              for (let i = currentLevel; i > level; i--) {
                listStack.pop();
                currentList = listStack[listStack.length - 1];
              }
            }
            
            currentList.appendChild(listItem);
            currentLevel = level;
          });
          
          tocNav.appendChild(tocList);
        }
        
        // Generate the TOC
        generateTOC();
        
        // Handle close button
        if (tocClose) {
          tocClose.addEventListener('click', function() {
            floatingToc.classList.remove('toc-open');
          });
        }
        
        // Handle click on icon to toggle
        const tocIcon = document.querySelector('.toc-icon');
        if (tocIcon) {
          tocIcon.addEventListener('click', function() {
            floatingToc.classList.toggle('toc-open');
          });
        }
        
        // Active section highlighting
        function updateActiveSection() {
          const headings = document.querySelectorAll('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6');
          const tocLinks = tocNav.querySelectorAll('a');
          
          // Remove active class from all links
          tocLinks.forEach(link => link.classList.remove('active'));
          
          // Find the current section
          let currentHeading = null;
          const scrollPosition = window.scrollY + 100; // Offset for better UX
          
          for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            const headingTop = heading.offsetTop;
            
            if (headingTop <= scrollPosition) {
              currentHeading = heading;
              break;
            }
          }
          
          // Add active class to current section
          if (currentHeading) {
            const activeLink = tocNav.querySelector(`a[href="#${currentHeading.id}"]`);
            if (activeLink) {
              activeLink.classList.add('active');
            }
          }
        }
        
        // Update active section on scroll
        let scrollTimeout;
        window.addEventListener('scroll', function() {
          if (scrollTimeout) {
            clearTimeout(scrollTimeout);
          }
          scrollTimeout = setTimeout(updateActiveSection, 10);
        });
        
        // Initial update
        updateActiveSection();
      } else if (floatingToc && !isSubStudyPage) {
        // Hide floating TOC on main study page
        floatingToc.style.display = 'none';
      }
      
      // Legacy TOC functionality (for existing markdown TOCs)
      const toc = document.querySelector('#markdown-toc');
      if (toc) {
        // Hide the floating TOC if there's already a markdown TOC
        if (floatingToc) {
          floatingToc.style.display = 'none';
        }
        
        // Create TOC container with header
        const tocContainer = document.createElement('div');
        tocContainer.className = 'toc-container';
        tocContainer.style.cssText = `
          background: #f8fafc;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 16px;
          margin: 20px 0;
          position: relative;
        `;
        
        // Add TOC header
        const tocHeader = document.createElement('h3');
        tocHeader.textContent = 'Table of Contents';
        tocHeader.style.cssText = `
          margin: 0 0 12px 0;
          font-size: 16px;
          font-weight: 600;
          color: #374151;
        `;
        
        // Add back to top button
        const backToTopBtn = document.createElement('button');
        backToTopBtn.textContent = '‚Üë Top';
        backToTopBtn.style.cssText = `
          position: absolute;
          top: 12px;
          right: 12px;
          background: #ffffff;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          padding: 4px 8px;
          font-size: 12px;
          cursor: pointer;
          color: #6b7280;
          transition: all 0.2s ease;
        `;
        
        // Add hover effect for back to top button
        backToTopBtn.addEventListener('mouseenter', function() {
          this.style.background = '#f3f4f6';
          this.style.color = '#374151';
        });
        
        backToTopBtn.addEventListener('mouseleave', function() {
          this.style.background = '#ffffff';
          this.style.color = '#6b7280';
        });
        
        // Back to top functionality
        backToTopBtn.addEventListener('click', function() {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Style the TOC list
        toc.style.cssText = `
          margin: 0;
          padding: 0;
          font-size: 14px;
          line-height: 1.5;
        `;
        
        // Insert header and button into container
        tocContainer.appendChild(tocHeader);
        tocContainer.appendChild(backToTopBtn);
        tocContainer.appendChild(toc);
        
        // Replace the original TOC with the new container
        toc.parentNode.insertBefore(tocContainer, toc);
        tocContainer.appendChild(toc);
        
        // Add smooth scrolling to TOC links
        const tocLinks = toc.querySelectorAll('a');
        tocLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: 'smooth' });
            }
          });
        });
      }
    });
  </script>
</body>
</html>
