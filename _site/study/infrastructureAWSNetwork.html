<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AWS Network Services ¬∑ glucolte</title>
  <meta name="description" content="notes ‚Ä¢ principles ‚Ä¢ systems">
  <link rel="stylesheet" href="/assets/style.css">
  <link rel="stylesheet" href="/assets/study.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AWS Network Services | glucolte</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="AWS Network Services" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="notes ‚Ä¢ principles ‚Ä¢ systems" />
<meta property="og:description" content="notes ‚Ä¢ principles ‚Ä¢ systems" />
<link rel="canonical" href="http://localhost:4000/study/infrastructureAWSNetwork" />
<meta property="og:url" content="http://localhost:4000/study/infrastructureAWSNetwork" />
<meta property="og:site_name" content="glucolte" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AWS Network Services" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"notes ‚Ä¢ principles ‚Ä¢ systems","headline":"AWS Network Services","url":"http://localhost:4000/study/infrastructureAWSNetwork"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="site-header">
  <a class="brand" href="/">glucolte</a>
  <nav class="nav">
    <a href="/principles">principles</a>
    <a href="/rules">rules</a>
    <a href="/stretches">stretches</a>
    <a href="/study/">study</a>
    <a href="/projects/">projects</a>
    <a href="/setup/">setup</a>
  </nav>
  <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
    <svg class="sun-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
    <svg class="moon-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>
</header>


  <main class="container">
    <article class="content">
      <h2 id="section-1-aws-network-overview">1. AWS Network Overview</h2>

<p>AWS operates one of the largest private <strong>fiber-optic backbones</strong> in the world. This backbone connects <strong>Data Centers</strong>, groups them into <strong>Availability Zones (AZs)</strong>, and links multiple AZs to form a <strong>Region</strong>. From there, AWS extends outwards through <strong>Points of Presence (PoPs)</strong>, which connect to the <strong>public internet</strong> or provide private connectivity via <strong>Direct Connect</strong>.</p>

<ol>
  <li><strong>Data Centers, AZs, and Regions</strong>
    <ul>
      <li><strong>Data Centers</strong> are the physical foundation.</li>
      <li>A group of data centers = an <strong>Availability Zone (AZ)</strong>.</li>
      <li>Several AZs = a <strong>Region</strong>, interconnected by the AWS backbone for <strong>low-latency, fault-tolerant networking</strong>.</li>
    </ul>
  </li>
  <li><strong>Points of Presence (PoPs)</strong>
    <ul>
      <li>AWS racks hosted inside <strong>third-party colocation sites</strong> (e.g., <em>Equinix, Digital Realty</em>).</li>
      <li>Link the AWS backbone to <strong>local ISPs</strong> and <strong>IXPs</strong>.</li>
      <li>Run edge services such as <strong>CloudFront</strong> (CDN caching) and <strong>Global Accelerator</strong> (traffic optimization).</li>
    </ul>
  </li>
  <li><strong>Public Internet Connectivity</strong>
    <ul>
      <li>PoPs handle AWS traffic <strong>in and out of the public internet</strong>.</li>
      <li>Customers reach AWS services through <strong>public endpoints</strong> (e.g., <em>S3, EC2 APIs</em>).</li>
    </ul>
  </li>
  <li><strong>Direct Connect (DX)</strong>
    <ul>
      <li>A <strong>dedicated private link</strong> that bypasses the internet.</li>
      <li>Provisioned at a PoP, giving you a <strong>physical port on AWS gear</strong>.</li>
      <li>Delivers <strong>lower latency, higher reliability, and consistent bandwidth</strong> for hybrid cloud workloads.</li>
    </ul>
  </li>
</ol>

<div class="image-wrapper">
  <img src="./assets/aws_network_general.png" alt="AWS Network Overview" class="modal-trigger" data-caption="AWS network architecture showing Data Centers, AZs, Regions, PoPs, and Direct Connect connectivity" />
  <div class="image-caption">üåê AWS Network Overview</div>
</div>

<hr />

<h2 id="section-2-service-categories">2. Service Categories</h2>
<h3 id="section-2-1-internet-connectivity-ingress-egress">2.1 Internet Connectivity (Ingress &amp; Egress)</h3>

<table class="study-table">
<thead>
<tr>
<th>AWS Service</th>
<th>Purpose</th>
<th>OSI Layer</th>
<th>Upstream</th>
<th>Downstream</th>
<th>Limitations</th>
<th>Pricing</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Internet Gateway (IGW)</strong></td>
<td>Enables VPC to access the internet.</td>
<td>L3 ‚Äì Network</td>
<td>Public Subnet</td>
<td>Internet</td>
<td>‚Ä¢ One IGW per VPC<br />‚Ä¢ No filtering (not a firewall)</td>
<td>Free</td>
</tr>
<tr>
<td><strong>NAT Gateway</strong></td>
<td>Allows private subnets to reach the internet.</td>
<td>L3 ‚Äì Network</td>
<td>Private Subnet</td>
<td>IGW / Internet</td>
<td>‚Ä¢ Outbound-only (no inbound)<br />‚Ä¢ Not HA by default (deploy per AZ)</td>
<td>Hourly charge + per GB data processing</td>
</tr>
<tr>
<td><strong>Virtual Private Gateway (VGW)</strong></td>
<td>AWS VPN tunnel endpoint for Site-to-Site VPN.</td>
<td>L3 ‚Äì Network</td>
<td>On-prem VPN device (CGW)</td>
<td>VPC Route Tables</td>
<td>‚Ä¢ One VGW per VPC<br />‚Ä¢ Max ~1.25 Gbps per tunnel<br />‚Ä¢ Cannot connect multiple VPCs directly</td>
<td>Hourly VPN + data transfer</td>
</tr>
<tr>
<td><strong>Customer Gateway (CGW)</strong></td>
<td>Customer-managed device establishing VPN tunnels to AWS.</td>
<td>L3 ‚Äì Network</td>
<td>On-prem Router/Firewall</td>
<td>VGW / TGW</td>
<td>‚Ä¢ Managed by customer<br />‚Ä¢ HA depends on design</td>
<td>N/A (customer hardware cost)</td>
</tr>
<tr>
<td><strong>Transit Gateway (TGW)</strong></td>
<td>Central router between VPCs, VPNs, and Direct Connect.</td>
<td>L3 ‚Äì Network</td>
<td>VPCs / VPN / DX</td>
<td>VPCs / VPN / DX</td>
<td>‚Ä¢ One RT per attachment<br />‚Ä¢ Propagation optional<br />‚Ä¢ Default full mesh<br />‚Ä¢ TGW Peering static routes only</td>
<td>Per attachment + per GB data processed</td>
</tr>
<tr>
<td><strong>Direct Connect (DX)</strong></td>
<td>Dedicated physical link to AWS, bypassing Internet.</td>
<td>L1 ‚Äì Physical</td>
<td>On-prem Router/Switch</td>
<td>VPC via TGW / VGW</td>
<td>‚Ä¢ Provisioning time weeks<br />‚Ä¢ No encryption by default<br />‚Ä¢ HA requires multiple DX</td>
<td>Per port-hour + data transfer (lower than internet egress)</td>
</tr>
</tbody>
</table>

<hr />
<table class="study-table">
<thead>
<tr>
<th>AWS Service</th>
<th>Purpose</th>
<th>OSI Layer</th>
<th>Upstream</th>
<th>Downstream</th>
<th>Limitations</th>
<th>Pricing</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>VPC Peering</strong></td>
<td>Connects two VPCs privately.</td>
<td>L2 (abstracted)</td>
<td>VPC A</td>
<td>VPC B</td>
<td>‚Ä¢ No transitive routing<br />‚Ä¢ Cannot use overlapping CIDRs</td>
<td>Data transfer per GB (intra-Region cheaper, inter-Region higher)</td>
</tr>
<tr>
<td><strong>Gateway Endpoints</strong></td>
<td>Route table entry to access <strong>S3/DynamoDB</strong> via AWS backbone.</td>
<td>L3 ‚Äì Network</td>
<td>VPC Subnet</td>
<td>S3 / DynamoDB</td>
<td>‚Ä¢ <strong>Only supports S3 and DynamoDB</strong><br />‚Ä¢ One per route table<br />‚Ä¢ Supports VPC endpoint policies</td>
<td>Free</td>
</tr>
<tr>
<td><strong>Interface Endpoints (PrivateLink)</strong></td>
<td>ENI-based private access to other AWS services or partner services.</td>
<td>L3 / L4</td>
<td>VPC Subnet / ENI</td>
<td>AWS Service ENI</td>
<td>‚Ä¢ <strong>Does NOT support S3/DynamoDB</strong> (use Gateway instead)<br />‚Ä¢ One per AZ for HA<br />‚Ä¢ Private DNS overrides service DNS<br />‚Ä¢ Supports VPC endpoint policies</td>
<td>Hourly ENI cost + per GB data processed</td>
</tr>
<tr>
<td><strong>Route 53 Resolver (.2)</strong></td>
<td>Built-in VPC DNS resolver (`.2` address in every subnet) for public zones and associated private zones.</td>
<td>L3 ‚Äì Network</td>
<td>EC2 / Lambda / ENI</td>
<td>Internal DNS targets (via `.2`)</td>
<td>‚Ä¢ VPC-only (not accessible from on-prem)<br />‚Ä¢ No customization<br />‚Ä¢ Hybrid DNS requires endpoints</td>
<td>Free (included with VPC)</td>
</tr>
<tr>
<td><strong>Route 53 Resolver Endpoints</strong></td>
<td>Extend DNS resolution across hybrid networks:<br />‚Ä¢ <em>Inbound</em> ‚Äì On-prem ‚Üí VPC resolver<br />‚Ä¢ <em>Outbound</em> ‚Äì VPC ‚Üí on-prem DNS</td>
<td>L3 ‚Äì Network</td>
<td>On-prem DNS or VPC resources</td>
<td>Route 53 Resolver / On-prem DNS</td>
<td>‚Ä¢ Requires ENIs in subnets<br />‚Ä¢ One per AZ for HA<br />‚Ä¢ Adds query latency vs. .2<br />‚Ä¢ Query-based limits</td>
<td>Hourly ENI cost + query-based pricing</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="section-2-2-load-balancing-and-traffic-distribution">2.2 Load Balancing and Traffic Distribution</h3>

<table class="study-table">
<thead>
<tr>
<th>AWS Service</th>
<th>Purpose</th>
<th>OSI Layer</th>
<th>Upstream</th>
<th>Downstream</th>
<th>Limitations</th>
<th>Pricing</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ALB (Application Load Balancer)</strong></td>
<td>Routes HTTP/HTTPS traffic.</td>
<td>L7 / L4</td>
<td>Internet / CloudFront</td>
<td>EC2 / Lambda / IPs</td>
<td>‚Ä¢ HTTP/HTTPS only<br />‚Ä¢ No static IPs (unless behind GA)</td>
<td>Hourly + per LCU + data processed</td>
</tr>
<tr>
<td><strong>NLB (Network Load Balancer)</strong></td>
<td>Balances TCP/UDP traffic.</td>
<td>L4 ‚Äì Transport</td>
<td>Internet / Internal VPC</td>
<td>EC2 / IPs</td>
<td>‚Ä¢ No advanced routing (L7)<br />‚Ä¢ Health checks limited</td>
<td>Hourly + per LCU + data processed</td>
</tr>
<tr>
<td><strong>Gateway Load Balancer (GWLB)</strong></td>
<td>Sends traffic to firewalls/appliances.</td>
<td>L3 / L4</td>
<td>IGW / NLB</td>
<td>Security Appliance</td>
<td>‚Ä¢ Appliances must support GENEVE<br />‚Ä¢ Adds latency</td>
<td>Hourly + per LCU + data processed</td>
</tr>
<tr>
<td><strong>Global Accelerator</strong></td>
<td>Routes global traffic via Anycast IPs.</td>
<td>L4 ‚Äì Transport</td>
<td>End User</td>
<td>NLB / ALB / IPs</td>
<td>‚Ä¢ Not a CDN<br />‚Ä¢ No caching</td>
<td>Per accelerator-hour + data transfer</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="section-2-3-security-and-access-control">2.3 Security and Access Control</h3>

<table class="study-table">
<thead>
<tr>
<th>AWS Service</th>
<th>Purpose</th>
<th>OSI Layer</th>
<th>Upstream</th>
<th>Downstream</th>
<th>Limitations</th>
<th>Pricing</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>WAF</strong></td>
<td>Filters HTTP/HTTPS requests.</td>
<td>L7 ‚Äì Application</td>
<td>CloudFront / ALB</td>
<td>ALB / API Gateway</td>
<td>‚Ä¢ L7 only<br />‚Ä¢ Rule limits apply</td>
<td>Per WCU (rule capacity unit) + requests</td>
</tr>
<tr>
<td><strong>AWS Shield / Advanced</strong></td>
<td>DDoS protection for infra/apps.</td>
<td>L3‚ÄìL7</td>
<td>Internet / Edge</td>
<td>VPC Entry Points</td>
<td>‚Ä¢ Shield Standard auto, Advanced = $$</td>
<td>Shield Std free, Advanced fixed monthly fee</td>
</tr>
<tr>
<td><strong>ACM</strong></td>
<td>Manages SSL/TLS certificates.</td>
<td>L6 ‚Äì Presentation</td>
<td>N/A (integrated)</td>
<td>CloudFront / ALB / API GW</td>
<td>‚Ä¢ Only ACM-issued certs auto-renew</td>
<td>Free for ACM-managed certs</td>
</tr>
<tr>
<td><strong>Security Groups / NACLs</strong></td>
<td>Allow/deny traffic at instance/subnet.</td>
<td>L3 / L4</td>
<td>Client / Peer Service</td>
<td>EC2 / ENI / Subnet</td>
<td>‚Ä¢ SG stateful, NACL stateless<br />‚Ä¢ NACL rules limit</td>
<td>Free</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="section-2-4-edge-services-and-dns">2.4 Edge Services and DNS</h3>

<table class="study-table">
<thead>
<tr>
<th>AWS Service</th>
<th>Purpose</th>
<th>OSI Layer</th>
<th>Upstream</th>
<th>Downstream</th>
<th>Limitations</th>
<th>Pricing</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CloudFront</strong></td>
<td>Distributes and caches content globally at PoP.</td>
<td>L7 ‚Äì Application</td>
<td>End Users</td>
<td>ALB / S3 / API GW</td>
<td>‚Ä¢ Cache invalidation costs<br />‚Ä¢ Regional edge cache not everywhere</td>
<td>Per request + data transfer out</td>
</tr>
<tr>
<td><strong>Route 53</strong></td>
<td>DNS resolution with routing policies.</td>
<td>L7 ‚Äì Application</td>
<td>End Users</td>
<td>IP / ALB / CloudFront</td>
<td>‚Ä¢ Query costs<br />‚Ä¢ Geo/latency policies add cost</td>
<td>Per hosted zone + per query</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="section-2-5-api-and-microservice-communication">2.5 API and Microservice Communication</h3>

<table class="study-table">
<thead>
<tr>
<th>AWS Service</th>
<th>Purpose</th>
<th>OSI Layer</th>
<th>Upstream</th>
<th>Downstream</th>
<th>Limitations</th>
<th>Pricing</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>API Gateway</strong></td>
<td>Expose/manage REST/HTTP/WebSocket APIs.</td>
<td>L7 ‚Äì Application</td>
<td>Client / CloudFront</td>
<td>Lambda / Service Backend</td>
<td>‚Ä¢ Payload size limits<br />‚Ä¢ Latency higher than ALB</td>
<td>Per million requests + data processed</td>
</tr>
<tr>
<td><strong>App Mesh</strong></td>
<td>Controls service-to-service traffic in a mesh.</td>
<td>L7 ‚Äì Application</td>
<td>Microservice A</td>
<td>Microservice B</td>
<td>‚Ä¢ Envoy sidecar overhead<br />‚Ä¢ Complexity</td>
<td>Per Envoy proxy-hour</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="section-2-6-core-networking-components">2.6 Core Networking Components</h3>

<table class="study-table">
<thead>
<tr>
<th>Component</th>
<th>Purpose</th>
<th>OSI Layer</th>
<th>Upstream</th>
<th>Downstream</th>
<th>Limitations</th>
<th>Pricing</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>VPC</strong></td>
<td>Isolated virtual network with subnets and routing.</td>
<td>L3 ‚Äì Network</td>
<td>Internet / VPN</td>
<td>Subnets</td>
<td>‚Ä¢ Max 5,000 subnets<br />‚Ä¢ CIDR block limits</td>
<td>Free</td>
</tr>
<tr>
<td><strong>Elastic Network Interface (ENI)</strong></td>
<td>Virtual NIC attached to resources.</td>
<td>L2 ‚Äì Data Link</td>
<td>Subnet / VPC</td>
<td>EC2 / Lambda</td>
<td>‚Ä¢ Limited ENIs per instance type</td>
<td>Free (included in instance cost)</td>
</tr>
</tbody>
</table>

<hr />

<h2 id="section-3-vpn">3. VPN</h2>

<p>Note VPN builds on top of IPSec, for details on how IPSec works, see <a href="/study/infrastructureOsiModel#layer-3-56---ipsec">3.4 Layer 3 &amp; 5‚Äì6 - IPsec</a></p>

<h3 id="section-3-1-site-to-site-vpn">3.1 Site-to-Site VPN</h3>

<ul>
  <li><strong>Purpose</strong>:
    <ul>
      <li><strong>Site-to-Site VPN = Network ‚Üî Network</strong></li>
      <li>Connects an entire on-premises network (via a CGW) to an AWS VPC network (via a VGW or TGW).</li>
      <li>Used for <strong>hybrid cloud connectivity</strong>, extending datacenter or branch office networks into AWS.</li>
      <li><strong>Example</strong>: Your office LAN can securely reach EC2 instances inside VPCs.</li>
    </ul>
  </li>
</ul>

<div class="image-wrapper">
  <img src="./assets/s2s_vpn.png" alt="S2S VPN Example" class="modal-trigger" data-caption="Site-to-Site VPN sequence showing CGW and VGW communication flow" />
  <div class="diagram-caption" data-snippet-id="s2s-snippet">
    üîê Site-to-Site VPN ‚Äì Communication Sequence
  </div>
  <!-- Keep your PlantUML raw here -->
  <script type="text/plain" id="s2s-snippet">
@startuml
title Classic VPN Setup with AWS Network (CGW and VGW)

participant OnPrem as "On-Premises Network"
participant ISP as "Internet Service Provider"
participant Internet as "AWS Public Internet"
participant VPC as "VPC (AWS Private Network)"

' Classic VPN (VGW method)
OnPrem -> ISP : From CGW: Request VPN Tunnel (IPsec Initiation)
ISP -> Internet : Forwards Tunnel Request
Internet -> VPC : Forwards Request to VGW
VPC -> Internet : From VGW: Sends Tunnel Setup Acknowledgement
Internet -> ISP : Sends Acknowledgement
ISP -> OnPrem : Tunnel Setup Confirmation to CGW

alt High Availability
    OnPrem -> ISP : Switch to Backup Tunnel (Tunnel 2)
    ISP -> Internet : Forwards Traffic to Backup Tunnel
    Internet -> VPC : Routes Traffic to Backup Tunnel
end

OnPrem -> VPC : Routes Traffic to VPC
OnPrem -> VPC : Continuous keep-alive messages
VPC -> VPC : Acknowledges Keep-alive

' Floating note at the very bottom
note across
  If you replace VGW with TGW (Transit Gateway),  
  the VPN becomes a scalable solution that can connect to multiple VPCs.  
  This allows a central hub (TGW) to route traffic between various VPCs,  
  providing more flexibility and scalability in larger environments.
end note

@enduml
  </script>
</div>

<h4 id="section-3-1-1-connectivity-types">3.1.1 Connectivity Types</h4>

<p>Keep in mind, VPN connections traverse the public Internet before reaching AWS‚Äôs network. Because of this, the routing path and how routes are exchanged are critical.</p>

<ul>
  <li><strong>Static VPN</strong>
    <ul>
      <li><strong>Route</strong>: Static routes in route tables (manual setup).</li>
      <li><strong>Pros</strong>: Simple setup.</li>
      <li><strong>Cons</strong>: No load balancing or failover.</li>
    </ul>
  </li>
  <li><strong>Dynamic VPN</strong>
    <ul>
      <li><strong>Route</strong>: Uses <strong>BGP</strong> for automatic route exchange.</li>
      <li><strong>Pros</strong>: High availability, automatic failover, and load balancing.</li>
      <li><strong>Cons</strong>: More complex setup.</li>
    </ul>
  </li>
</ul>

<h4 id="section-3-1-2-deployment-workflow">3.1.2 Deployment Workflow</h4>

<ul>
  <li><strong>Step 1: Create TGW and Attachments</strong>
    <ul>
      <li>Create TGW (default RT = <strong>Route Table A</strong>).</li>
      <li>Attach: <strong>VPC1</strong>, <strong>VPC2</strong>, and <strong>On-premises</strong> (via VPN or Direct Connect).</li>
      <li>Notes on VPN connectivity:
        <ul>
          <li>Uses the <strong>AWS Global Network</strong>, but tunnels still traverse the <strong>public Internet</strong>.</li>
          <li>Provides <strong>2 resilient public endpoints</strong> with <strong>2 IPSec tunnels</strong> for redundancy.</li>
          <li>Performance, latency, and consistency vary due to Internet hops.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Step 2: Configure TGW Route Table &amp; Associations</strong>
    <ul>
      <li>By default, all attachments are <strong>associated</strong> with the TGW‚Äôs default route table (<strong>Route Table A</strong>).</li>
      <li>You can create <strong>custom TGW route tables</strong> and associate attachments to them for segmentation (e.g., Dev vs Prod).</li>
      <li>For this setup, keep <strong>VPC1</strong>, <strong>VPC2</strong>, and <strong>On-premises</strong> associated to <strong>Route Table A</strong>, but remove cross-VPC routes so <strong>VPC1 ‚Üî VPC2</strong> traffic is blocked.</li>
    </ul>
  </li>
  <li><strong>Step 3: Configure VPC Route Tables</strong>
    <ul>
      <li><strong>VPC1 RT</strong>: Add <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code> ‚Üí TGW Attachment (for On-prem). No route to VPC2.</li>
      <li><strong>VPC2 RT</strong>: Add <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code> ‚Üí TGW Attachment (for On-prem). No route to VPC1.</li>
    </ul>
  </li>
  <li><strong>Step 4: On-premises Integration (Propagation)</strong>
    <ul>
      <li>Enable <strong>propagation</strong> from On-prem ‚Üí TGW RT so both VPCs can learn routes automatically.</li>
      <li>Ensure On-prem routes are advertised back to TGW.</li>
      <li>Options to connect:
        <ol>
          <li><strong>VGW ‚Üí CGW (1:1 VPC)</strong></li>
          <li><strong>TGW ‚Üí CGW (1:M VPCs)</strong></li>
          <li><strong>Accelerated Site-to-Site VPN (TGW only)</strong></li>
          <li><strong>Direct Connect (DX)</strong>:
            <ul>
              <li><strong>Private VIF</strong> ‚Üí For VPC connectivity via TGW/VGW.</li>
              <li><strong>Public VIF</strong> ‚Üí For AWS public services (not VPC routing).</li>
              <li><strong>Transit VIF</strong> ‚Üí For scaling via TGW to multiple VPCs (enterprise-scale option).</li>
            </ul>
          </li>
        </ol>
      </li>
    </ul>
  </li>
  <li><strong>Step 5: BGP Exchange Sequence (Dynamic VPN)</strong>
    <ol>
      <li><strong>On-Prem Router Configures BGP ASN</strong> ‚Üí prepares to exchange routes.</li>
      <li><strong>Advertises Internal Routes</strong> ‚Üí on-prem router sends subnets (e.g., <code class="language-plaintext highlighter-rouge">192.168.1.0/24</code>).</li>
      <li><strong>AWS VPN Gateway Setup</strong> ‚Üí VPN tunnels established.</li>
      <li><strong>BGP Peering</strong> ‚Üí session formed between on-prem router and AWS VPN Gateway.</li>
      <li><strong>Route Advertisement</strong> ‚Üí AWS advertises VPC subnets to the on-prem router.</li>
      <li><strong>Route Learning</strong> ‚Üí on-prem router learns AWS subnets via BGP.</li>
      <li><strong>Traffic to AWS</strong> ‚Üí routed to TGW using BGP-learned paths.</li>
      <li><strong>TGW Forwarding</strong> ‚Üí TGW routes traffic to the correct VPC.</li>
      <li><strong>Return Traffic from AWS</strong> ‚Üí VPC ‚Üí TGW ‚Üí VPN tunnels ‚Üí back to on-prem router.</li>
    </ol>
  </li>
  <li><strong>Resulting Traffic Flows</strong>
    <ul>
      <li><strong>VPC1 ‚Üí TGW ‚Üí On-premises</strong> ‚úÖ</li>
      <li><strong>VPC2 ‚Üí TGW ‚Üí On-premises</strong> ‚úÖ</li>
      <li><strong>VPC1 ‚Üî VPC2</strong> ‚ùå (blocked by TGW RT config)</li>
    </ul>
  </li>
</ul>

<h4 id="section-3-1-3-operational-considerations">3.1.3 Operational Considerations</h4>

<ul>
  <li><strong>Speed</strong>: Maximum throughput is <strong>1.25 Gbps</strong> per VPN tunnel.</li>
  <li><strong>Latency</strong>: Varies and can be inconsistent, as traffic traverses the public Internet.</li>
  <li><strong>Cost</strong>: Hourly charges per VPN connection, plus standard AWS data transfer fees (outbound GB).</li>
  <li><strong>Provisioning Speed</strong>: Quick to set up, as VPNs are software-based and do not require physical circuits.</li>
  <li><strong>High Availability</strong>:
    <ul>
      <li>Each VPN connection can support two tunnels for redundancy.</li>
      <li>HA depends on having multiple on-premises customer gateways (e.g., in different locations).</li>
    </ul>
  </li>
  <li><strong>Integration with Direct Connect</strong>:
    <ul>
      <li>VPNs can serve as a <strong>backup for DX</strong> (failover).</li>
      <li>VPN and DX can be used together for <strong>hybrid redundancy</strong>.</li>
    </ul>
  </li>
</ul>

<hr />

<h3 id="section-3-2-client-vpn">3.2 Client VPN</h3>

<p>AWS Client VPN is a <strong>fully managed OpenVPN-based service</strong> that allows <strong>individual users</strong> (laptops, developers, admins, remote workers) to securely connect to AWS resources and on-premises networks.</p>

<ul>
  <li><strong>Purpose</strong>:
    <ul>
      <li><strong>Client VPN = User ‚Üî Network</strong></li>
      <li>Unlike Site-to-Site VPN (which connects entire networks), Client VPN provides <strong>user-level access</strong> into AWS.</li>
    </ul>
  </li>
  <li><strong>Architecture</strong>:
    <ul>
      <li>Users connect to a <strong>Client VPN Endpoint</strong> deployed in a VPC.</li>
      <li>The endpoint is associated with one or more <strong>subnets (ENIs)</strong> across AZs for high availability.</li>
      <li>Billed based on the number of <strong>network associations</strong> and connected clients.</li>
    </ul>
  </li>
  <li><strong>Use Cases</strong>:
    <ul>
      <li>Remote workforce access to AWS resources in a VPC.</li>
      <li>Secure developer/admin access without requiring a full corporate VPN.</li>
      <li>Extending access into on-premises networks if Client VPN is associated with a TGW or VGW.</li>
    </ul>
  </li>
  <li><strong>VPN Types</strong>:
    <ul>
      <li><strong>Full Tunnel</strong>: All traffic (AWS + Internet) routes through the VPN.</li>
      <li><strong>Split Tunnel</strong> (not default): Only AWS/VPC traffic routes through the VPN; Internet-bound traffic goes out locally.</li>
    </ul>
  </li>
  <li><strong>Authentication</strong>:
    <ul>
      <li><strong>Certificate-based</strong> (via ACM).</li>
      <li><strong>Identity-based</strong> (Active Directory, SAML, or federated IdPs).</li>
    </ul>
  </li>
  <li><strong>Setup Workflow</strong>:
    <ol>
      <li><strong>Create Certificates in ACM</strong>
        <ul>
          <li>Server certificate for the VPN endpoint.</li>
          <li>Client certificates for users.</li>
          <li>Certificates are used to establish trust between client and server.</li>
        </ul>
      </li>
      <li><strong>Create Client VPN Endpoint</strong> in AWS.</li>
      <li><strong>Associate Subnets (ENIs)</strong> across AZs for HA.</li>
      <li><strong>Configure Authorization Rules</strong> (which clients can access which networks).</li>
      <li><strong>Add a DNS Server IP</strong> (so clients can resolve hostnames inside the VPC).</li>
      <li><strong>Download/OpenVPN configuration file</strong> and distribute to clients.</li>
      <li>Clients connect using an <strong>OpenVPN-compatible client</strong>.</li>
    </ol>
  </li>
</ul>

<h4 id="section-3-2-1-connection-sequence">3.2.1 Connection Sequence</h4>

<div class="image-wrapper">
  <img src="./assets/client_vpn_general.png" alt="Client VPN Example" class="modal-trigger" data-caption="Client VPN sequence showing user connecting to AWS Client VPN Endpoint" />
  <div class="diagram-caption" data-snippet-id="client-vpn-snippet">
    üîê Client VPN ‚Äì Authentication &amp; Connection Flow
  </div>
  <!-- Keep your PlantUML raw here -->
  <script type="text/plain" id="client-vpn-snippet">
@startuml
title AWS Client VPN Connection Flow

actor User as "Client Device"
participant VPNClient as "OpenVPN Client"
participant ACM as "AWS ACM Certificates"
participant ClientVPN as "AWS Client VPN Endpoint (ENI in VPC)"
participant DNS as "DNS Server"
participant VPC as "Target VPC Subnets"

User -> VPNClient : Launch VPN client, provide cert/credentials
VPNClient -> ACM : Verify certificates (Server & Client)
ACM -> VPNClient : Certificate validation success
VPNClient -> ClientVPN : Establish TLS/SSL Tunnel
ClientVPN -> DNS : (Optional) Use configured DNS server
ClientVPN -> VPC : Route traffic to AWS VPC Subnets

note across
  Split Tunnel Option:
  - If enabled: Only AWS/VPC traffic goes through VPN.
  - If disabled (Full Tunnel): All client traffic routes via VPN.
end note
@enduml
  </script>
</div>

<hr />

<h2 id="section-4-route-tables">4. Route Tables</h2>

<ul>
  <li><strong>VPC Route Tables</strong>: Decide routing inside each VPC.</li>
  <li><strong>TGW Route Tables</strong>: Decide routing between VPCs, VPNs, and On-prem.</li>
  <li><strong>Association</strong>: Each attachment (VPC, VPN, DX) can only be linked to <strong>one TGW RT</strong>.</li>
  <li>
    <p><strong>Propagation</strong>: Routes can automatically flow into TGW RTs (e.g., from VPN or On-prem).</p>
  </li>
  <li><strong>Routing Priority</strong>:
    <ul>
      <li>Inside VPC ‚Üí VPC RT applies.</li>
      <li>Across attachments ‚Üí TGW RT applies.</li>
      <li><strong>Longest prefix match</strong> always wins.</li>
      <li><strong>Static routes</strong> take precedence over propagated routes.</li>
      <li>If multiple propagated routes exist, AWS evaluates in this order:
        <ol>
          <li>Direct Connect (DX)</li>
          <li>VPN Static</li>
          <li>VPN BGP</li>
          <li>AS_PATH length (shortest wins)</li>
        </ol>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Subnet Association</strong>: Each subnet can only be associated with <strong>one RT</strong> (main or custom).</p>
  </li>
  <li><strong>CIDR Overlap</strong>:
    <ul>
      <li>Use separate RTs per subnet to send traffic to different VPCs with the same CIDR.</li>
      <li>Or rely on more specific prefixes, since routing favors specificity.</li>
    </ul>
  </li>
  <li><strong>Ingress Routing (Gateway Route Tables)</strong>:
    <ul>
      <li>Enables inspection/control of <strong>inbound traffic flows</strong>.</li>
      <li>Previously, RTs only controlled <strong>outbound</strong> traffic; ingress routing extends this capability for security appliances.</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="section-5-direct-connect">5. Direct Connect</h2>

<p>AWS Direct Connect (DX) provides a <strong>dedicated, private network connection</strong> between your on-premises environment and AWS. Unlike VPN (which traverses the Internet), DX offers <strong>consistent latency, predictable bandwidth, and enterprise-grade reliability</strong>.</p>

<h3 id="section-5-1-direct-connect-physical-architecture">5.1 Direct Connect Physical Architecture</h3>

<ul>
  <li><strong>Port Speeds</strong>: 1 / 10 / 100 Gbps
    <ul>
      <li>1 Gbps ‚Üí <code class="language-plaintext highlighter-rouge">1000BASE-LX</code> (1310 nm)</li>
      <li>10 Gbps ‚Üí <code class="language-plaintext highlighter-rouge">10GBASE-LR</code> (1310 nm)</li>
      <li>100 Gbps ‚Üí <code class="language-plaintext highlighter-rouge">100GBASE-LR4</code></li>
    </ul>
  </li>
  <li><strong>Medium</strong>: Single-mode fiber only (no copper).</li>
  <li><strong>Configuration</strong>: Auto-negotiation disabled ‚Üí both ends must manually set <strong>speed</strong> and <strong>full-duplex</strong>.</li>
  <li><strong>Routing</strong>: Uses <strong>BGP with MD5 authentication</strong>.</li>
  <li><strong>Optional</strong>:
    <ul>
      <li><strong>MACsec (802.1AE)</strong> for Layer 2 encryption.</li>
      <li><strong>Bidirectional Forwarding Detection (BFD)</strong> for fast failure detection.</li>
    </ul>
  </li>
</ul>

<h3 id="section-5-2-macsec-security-layer">5.2 MACsec Security Layer</h3>

<p>DX traffic is not encrypted by default. <strong>MACsec</strong> secures the <strong>physical hop</strong> between your router and AWS‚Äôs DX router at the PoP.</p>

<ul>
  <li><strong>Scope</strong>: Frame-level encryption (Layer 2).</li>
  <li><strong>Guarantees</strong>: Confidentiality, integrity, origin authentication, replay protection.</li>
  <li><strong>Performance</strong>: Hardware-accelerated, minimal overhead at 10/100 Gbps.</li>
  <li><strong>Mechanism</strong>: Secure Channels, Secure Associations, SCI identifiers, 16B tag + 16B ICV.</li>
  <li><strong>Limitations</strong>: Not end-to-end; only protects between directly connected devices. Use <strong>IPsec over DX</strong> if end-to-end encryption is required.</li>
</ul>

<h3 id="section-5-3-direct-connect-provisioning-workflow">5.3 Direct Connect Provisioning Workflow</h3>

<ol>
  <li><strong>LOA-CFA (Letter of Authorization ‚Äì Connecting Facility Assignment)</strong>
    <ul>
      <li>AWS allocates a port inside their cage at the DX location (PoP).</li>
      <li>You receive LOA-CFA to hand to your provider or colo staff.</li>
    </ul>
  </li>
  <li><strong>Physical Cross-Connect</strong>
    <ul>
      <li>Fiber is patched between your cage/router and the AWS DX router at the PoP.</li>
      <li>Ports are set with matching speed/duplex.</li>
    </ul>
  </li>
</ol>

<h3 id="section-5-4-direct-connect-virtual-interfaces">5.4 Direct Connect Virtual Interfaces</h3>

<p>DX is a <strong>Layer 2 link</strong>. To run multiple logical networks, DX uses <strong>802.1Q VLANs</strong>, each mapping to a <strong>Virtual Interface (VIF)</strong> on the AWS side.</p>
<ul>
  <li><strong>Each VIF = one VLAN + one BGP session.</strong></li>
  <li>On the customer side: configure sub-interfaces (per VLAN) with BGP.</li>
</ul>

<p><strong>Types of VIFs</strong>:</p>
<ol>
  <li><strong>Private VIF</strong>
    <ul>
      <li>Connects to <strong>VGW</strong> (1 VPC) or <strong>TGW</strong> (multiple VPCs).</li>
      <li>Used for <strong>private VPC IP ranges</strong>.</li>
      <li>Region-specific (per DX location).</li>
      <li>1 VIF = 1 VGW = 1 VPC (unless TGW is used).</li>
      <li>No built-in encryption.</li>
    </ul>
  </li>
  <li><strong>Public VIF</strong>
    <ul>
      <li>Connects to <strong>AWS public endpoints</strong> (e.g., S3, DynamoDB, STS).</li>
      <li>AWS advertises <strong>all public IP prefixes</strong>; you advertise your <strong>public IPs</strong>.</li>
      <li>Global scope (all AWS regions).</li>
      <li>Not transitive: your prefixes are not re-shared by AWS.</li>
      <li>Can combine with VPN for <strong>DX + VPN</strong> (low latency + encryption).</li>
    </ul>
  </li>
  <li><strong>Transit VIF</strong>
    <ul>
      <li>Connects via <strong>DX Gateway (DXGW) ‚Üí TGW</strong>.</li>
      <li>Scales to <strong>multiple VPCs across accounts/regions</strong>.</li>
      <li>Requires BGP.</li>
      <li>Enterprise-scale hub-and-spoke hybrid connectivity.</li>
    </ul>
  </li>
</ol>

<h3 id="section-5-5-direct-connect-gateway">5.5 Direct Connect Gateway</h3>

<ul>
  <li>DX is <strong>per-region</strong>, but DXGW allows sharing across accounts and regions.</li>
  <li><strong>Public VIFs</strong>: Can access all AWS regions (since public IPs are global).</li>
  <li><strong>Private VIFs</strong>: Normally regional, but DXGW extends them to multiple regions via VGWs or TGWs.</li>
  <li>Enables <strong>multi-account, multi-region hybrid architectures</strong>.</li>
</ul>

<h3 id="section-5-6-operational-considerations">5.6 Operational Considerations</h3>

<ul>
  <li><strong>Speed</strong>: Up to 100 Gbps, depending on DX location/provider.</li>
  <li><strong>Encryption</strong>: Not built-in ‚Üí use <strong>MACsec</strong> (L2 hop-by-hop) or <strong>VPN over DX</strong> (end-to-end).</li>
  <li><strong>Resiliency</strong>: Use redundant DX links at different PoPs for HA.</li>
  <li><strong>Cost</strong>: Port-hour charges + data transfer (cheaper than Internet egress).</li>
  <li><strong>Provisioning</strong>: Weeks (physical cabling) vs minutes for VPN.</li>
  <li><strong>Routing Priority</strong>:
    <ul>
      <li>Longest prefix match always wins.</li>
      <li>Static &gt; propagated.</li>
      <li>Typically, DX &gt; VPN for the same prefix.</li>
    </ul>
  </li>
  <li><strong>Best Practice</strong>: DX + VPN (over DX Public VIF) = encrypted, resilient connectivity.</li>
</ul>

<h3 id="section-5-7-connection-sequence">5.7 Connection Sequence</h3>

<div class="image-wrapper">
  <img src="./assets/dx_general.png" alt="Direct Connect Flow" class="modal-trigger" data-caption="Direct Connect sequence flow (on-premises to AWS)" />
  <div class="diagram-caption" data-snippet-id="dx-snippet">
    üîå Direct Connect ‚Äì Physical + VIF Sequence
  </div>
  <script type="text/plain" id="dx-snippet">
@startuml
title AWS Direct Connect ‚Äì VLAN to VIF Mapping

participant OnPrem as "On-Prem Router"
entity DXPort as "AWS DX Router (PoP Port)"
entity VIF_Private as "Private VIF (VLAN 101)"
entity VIF_Public as "Public VIF (VLAN 102)"
entity VIF_Transit as "Transit VIF (VLAN 103)"
entity VGW as "VGW (VPC)"
entity PublicAWS as "AWS Public Services"
entity TGW as "Transit Gateway"

OnPrem -> DXPort : Establish physical DX connection (Fiber, 1/10/100 Gbps)

== VLAN Segregation on On-Prem Router ==
OnPrem -> DXPort : Tag traffic with VLAN 101 (Private)\n+ configure sub-interface + BGP
OnPrem -> DXPort : Tag traffic with VLAN 102 (Public)\n+ configure sub-interface + BGP
OnPrem -> DXPort : Tag traffic with VLAN 103 (Transit)\n+ configure sub-interface + BGP

== VIF Mapping in AWS Console ==
DXPort -> VIF_Private : Map VLAN 101 ‚Üí Private VIF
DXPort -> VIF_Public : Map VLAN 102 ‚Üí Public VIF
DXPort -> VIF_Transit : Map VLAN 103 ‚Üí Transit VIF

== Routing Outcomes ==
VIF_Private -> VGW : Routes to one VPC (via VGW) or multiple VPCs (via TGW)
VIF_Public -> PublicAWS : Routes to global AWS public services
VIF_Transit -> TGW : Routes to multiple VPCs via TGW/DXGW

note right of DXPort
Each VLAN = one isolated logical path
Each VIF = AWS-side construct\nterminating that VLAN
Each VIF requires a BGP session
end note
@enduml
  </script>
</div>

<hr />

<h2 id="section-6-domain-name-system-dns">6. Domain Name System (DNS)</h2>

<p>DNS (Domain Name System) resolves human-readable domain names (e.g., <code class="language-plaintext highlighter-rouge">example.com</code>) into IP addresses or service endpoints. In AWS, <strong>Route 53</strong> provides DNS hosting, routing policies, and integration with AWS resources (via Alias records).</p>

<p>üëâ <strong>Important distinction</strong>:</p>
<ul>
  <li><strong>DNS Hosting</strong>: Runs authoritative DNS servers that store and answer queries for your domain‚Äôs records.
    <ul>
      <li>Stores <strong>zone files</strong> (the authoritative set of DNS records for your domain).</li>
      <li>Uses <strong>name servers (NS records)</strong>, which are basically the servers that host and respond with your zone file data.</li>
      <li>Examples: Route 53, Cloudflare, GoDaddy DNS.</li>
    </ul>
  </li>
  <li><strong>TLD Registry / Registrar</strong>: Manages ownership of domain names under a top-level domain (TLD), like <code class="language-plaintext highlighter-rouge">.com</code> or <code class="language-plaintext highlighter-rouge">.org</code>.
    <ul>
      <li>The <strong>registry</strong> (e.g., Verisign for <code class="language-plaintext highlighter-rouge">.com</code>, PIR for <code class="language-plaintext highlighter-rouge">.org</code>) maintains the authoritative database of who owns each domain.</li>
      <li>The <strong>registrar</strong> (e.g., GoDaddy, Namecheap) is where you register, renew, or transfer domains.</li>
    </ul>
  </li>
  <li>These can be provided by the <strong>same company</strong> (e.g., GoDaddy = registrar + DNS host) or by <strong>different ones</strong> (e.g., register with Namecheap, host DNS with Route 53).</li>
</ul>

<h3 id="section-6-1-common-dns-record-types">6.1 Common DNS Record Types</h3>

<table class="study-table">
<thead>
<tr>
<th>Record Type</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A</strong></td>
<td>Maps domain ‚Üí IPv4 address</td>
<td><code>example.com. IN A 192.0.2.1</code></td>
</tr>
<tr>
<td><strong>AAAA</strong></td>
<td>Maps domain ‚Üí IPv6 address</td>
<td><code>example.com. IN AAAA 2001:db8::1</code></td>
</tr>
<tr>
<td><strong>CNAME</strong></td>
<td>Alias to another domain (not IP)</td>
<td><code>www.example.com. IN CNAME example.globalcdn.com.</code></td>
</tr>
<tr>
<td><strong>Alias</strong></td>
<td>AWS-only alias to ELB, CloudFront, S3, etc. Works at root domain.</td>
<td><code>example.com. IN A Alias abc123.cloudfront.net</code></td>
</tr>
<tr>
<td><strong>MX</strong></td>
<td>Mail routing</td>
<td><code>example.com. IN MX 10 mail1.google.com.</code></td>
</tr>
<tr>
<td><strong>TXT</strong></td>
<td>Metadata (SPF, DKIM, domain verification)</td>
<td><code>example.com. IN TXT "v=spf1 include:_spf.google.com ~all"</code></td>
</tr>
<tr>
<td><strong>NS</strong></td>
<td>Authoritative nameservers for zone</td>
<td><code>example.com. IN NS ns1.dnsprovider.com.</code></td>
</tr>
<tr>
<td><strong>SOA</strong></td>
<td>Zone info (serial, refresh, retry)</td>
<td><code>example.com. IN SOA ns1 hostmaster 2025010101 3600 1800 1209600 86400</code></td>
</tr>
<tr>
<td><strong>PTR</strong></td>
<td>Reverse DNS (IP ‚Üí domain)</td>
<td><code>1.2.0.192.in-addr.arpa. IN PTR example.com.</code></td>
</tr>
<tr>
<td><strong>CAA</strong></td>
<td>Restricts which CAs can issue certificates</td>
<td><code>example.com. IN CAA 0 issue "letsencrypt.org"</code></td>
</tr>
<tr>
<td><strong>SRV</strong></td>
<td>Service-specific record (e.g., SIP, LDAP)</td>
<td><code>_sip._tcp.example.com. IN SRV 10 60 5060 sipserver.example.com.</code></td>
</tr>
</tbody>
</table>

<h3 id="section-6-2-apex-naked-domains">6.2 Apex (Naked) Domains</h3>

<ul>
  <li>A <strong>naked domain</strong> = root (e.g., <code class="language-plaintext highlighter-rouge">example.com</code>) without subdomain.</li>
  <li>CNAMEs <strong>cannot</strong> be used at the root.</li>
  <li>In AWS ‚Üí use <strong>Alias records</strong> to map apex domains to AWS resources (e.g., ELB, CloudFront).</li>
  <li>For non-apex domains (<code class="language-plaintext highlighter-rouge">www.example.com</code>), use <strong>CNAME</strong>.</li>
</ul>

<h3 id="section-6-3-route-53-routing-policies">6.3 Route 53 Routing Policies</h3>

<table class="study-table">
<thead>
<tr>
<th>Routing Policy</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Simple</strong></td>
<td>Single record ‚Üí single resource</td>
<td><code>example.com ‚Üí 192.0.2.1</code></td>
</tr>
<tr>
<td><strong>Weighted</strong></td>
<td>Split traffic by % between resources</td>
<td><code>80% ‚Üí server1, 20% ‚Üí server2</code></td>
</tr>
<tr>
<td><strong>Latency</strong></td>
<td>Route to lowest-latency region</td>
<td>US users ‚Üí us-east-1, EU users ‚Üí eu-west-1</td>
</tr>
<tr>
<td><strong>Failover</strong></td>
<td>Primary resource + backup on failure</td>
<td>Main site ‚Üí backup site</td>
</tr>
<tr>
<td><strong>Geolocation</strong></td>
<td>Route by user‚Äôs country/region</td>
<td>US ‚Üí 192.0.2.1, UK ‚Üí 192.0.2.2</td>
</tr>
<tr>
<td><strong>Geoproximity</strong></td>
<td>Route by distance + optional bias</td>
<td>East Coast users ‚Üí NJ DC, West Coast ‚Üí CA DC</td>
</tr>
<tr>
<td><strong>Multi-Value</strong></td>
<td>Return multiple IPs for LB/HA</td>
<td>example.com ‚Üí 192.0.2.1, 192.0.2.2</td>
</tr>
<tr>
<td><strong>IP-based</strong></td>
<td>Route by client IP blocks</td>
<td>Corp IP range ‚Üí private endpoint</td>
</tr>
</tbody>
</table>

<h3 id="section-6-4-dns-resolution-flow">6.4 DNS Resolution Flow</h3>

<ol>
  <li>You create a <strong>Hosted Zone</strong> in Route 53 for your domain (<code class="language-plaintext highlighter-rouge">example.com</code>).</li>
  <li>Route 53 assigns <strong>4 authoritative name servers (NS records)</strong> for the domain.</li>
  <li>You add DNS records (A, CNAME, MX, TXT, etc.) inside the hosted zone.</li>
  <li>When a client queries <code class="language-plaintext highlighter-rouge">example.com</code>, the DNS resolver follows the chain:
    <ul>
      <li>Root ‚Üí TLD ‚Üí <strong>Route 53 authoritative NS</strong> (Amazon-managed).</li>
    </ul>
  </li>
  <li>Route 53 authoritative servers return the DNS record (e.g., A record with an IP).</li>
  <li>Resolver caches and returns result to user ‚Üí user connects to the target resource.</li>
</ol>

<div class="image-wrapper">
  <img src="./assets/dns_resolution_flow.png" alt="DNS Resolution Flow" class="modal-trigger" data-caption="DNS resolution sequence flow (user to AWS Route 53)" />
  <div class="diagram-caption" data-snippet-id="dns-snippet">
    üåê DNS Resolution ‚Äì Query to Answer
  </div>
  <script type="text/plain" id="dns-snippet">
@startuml
title DNS Resolution Flow (Normal + DNSSEC)

actor User
participant Resolver as "DNS Resolver (Recursive)"
participant Root as "Root DNS (.)"
participant TLD as "TLD DNS (.com - Parent Zone)"
participant Authoritative as "Authoritative DNS (Route 53 for example.com)"

== Normal DNS Resolution ==
User -> Resolver : Query "example.com"

note right of Resolver : Step 1: Resolver receives query from User.

Resolver -> Root : Ask for NS of ".com"
Root --> Resolver : Referral: TLD servers for .com

note right of Resolver : Step 2: Resolver learns TLD servers.

Resolver -> TLD : Ask for NS of "example.com"
TLD --> Resolver : Referral: NS for "example.com" (Authoritative)

note right of Resolver : Step 3: Resolver learns authoritative NS.

Resolver -> Authoritative : Query DNS records (A, MX) for "example.com"
Authoritative --> Resolver : Return records (A, MX)

Resolver --> User : Return resolved records (e.g., A = 203.0.113.10)
User -> Authoritative : Connect using resolved IP
@enduml
  </script>
</div>

<h3 id="section-6-5-dnssec-overview">6.5 DNSSEC Overview</h3>

<p><strong>DNSSEC (Domain Name System Security Extensions)</strong> adds a <strong>security layer</strong> to DNS. Normal DNS just maps names ‚Üí IPs, but DNSSEC ensures responses are <strong>authentic</strong> and <strong>untampered</strong> by digitally signing DNS records.</p>

<blockquote>
  <p>üîë <strong>Why we need DNSSEC</strong>: Without it, DNS is vulnerable to <strong>cache poisoning, spoofing, and MITM attacks</strong>.<br />
‚úÖ <strong>DNSSEC prevents this</strong> by providing a <strong>cryptographic chain of trust</strong> from the <strong>Root</strong> ‚Üí <strong>TLD</strong> ‚Üí <strong>Authoritative server</strong>.<br />
‚ö†Ô∏è <strong>Note</strong>: DNSSEC does <strong>not encrypt traffic</strong> (unlike HTTPS). It only guarantees <strong>authenticity + integrity</strong>, not confidentiality.</p>
</blockquote>

<h4 id="section-6-5-1-key-concepts">6.5.1 Key Concepts</h4>

<ul>
  <li><strong>Digital Signatures</strong>:
    <ul>
      <li><strong>Authoritative servers</strong> sign records with a <strong>private key</strong>.</li>
      <li><strong>Resolvers</strong> validate them with the <strong>public key</strong>.</li>
    </ul>
  </li>
  <li><strong>DNSSEC Records</strong>:
    <ul>
      <li><strong>DNSKEY</strong> ‚Üí Public key of a DNS zone.</li>
      <li><strong>DS (Delegation Signer)</strong> ‚Üí Stored in the parent zone, links child zone‚Äôs key.</li>
      <li><strong>RRSIG</strong> ‚Üí Digital signature attached to DNS records.</li>
    </ul>
  </li>
  <li><strong>Chain of Trust</strong>:
    <ul>
      <li>Starts at the <strong>Root zone</strong> (trust anchor),</li>
      <li>Delegates to <strong>TLD (.com)</strong>,</li>
      <li>Passes down to the <strong>Authoritative DNS</strong> (e.g., Route 53).</li>
    </ul>
  </li>
</ul>

<h4 id="section-6-5-2-roles-and-responsibilities">6.5.2 Roles and Responsibilities</h4>

<ul>
  <li><strong>Root &amp; TLD Operators (ICANN, Verisign, etc.)</strong> ‚Üí Maintain signed root/TLD zones.</li>
  <li><strong>Domain Owners</strong> ‚Üí Enable DNSSEC in their DNS service (e.g., Route 53), publish DS record at registrar.</li>
  <li><strong>Resolvers (e.g., ISP, Google DNS, Cloudflare)</strong> ‚Üí Validate signatures automatically.</li>
  <li><strong>End Users</strong> ‚Üí Do nothing; they just benefit from secure DNS responses.</li>
</ul>

<h4 id="section-6-5-3-dnssec-resolution-flow">6.5.3 DNSSEC Resolution Flow</h4>

<div class="image-wrapper">
  <img src="./assets/dnssec_resolution_flow.png" alt="DNSSEC Resolution Flow" class="modal-trigger" data-caption="DNSSEC resolution flow with chain of trust" />
  <div class="diagram-caption" data-snippet-id="dnssec-snippet">
    üîê DNSSEC Resolution ‚Äì Validating DNS records with chain of trust
  </div>
  <script type="text/plain" id="dnssec-snippet">
@startuml
title DNS Resolution Flow (DNSSEC-enabled)

actor User
participant Resolver as "DNS Resolver (Recursive)"
participant Root as "Root DNS (.) - ICANN"
participant TLD as "TLD DNS (.com - Registry Operator)"
participant Authoritative as "Authoritative DNS (e.g., Route 53 for example.com)"

User -> Resolver : Query "example.com" (with DNSSEC enabled)

' Step 1 - Ask Parent
Resolver -> TLD : Query DS for "example.com"
TLD --> Resolver : DS + RRSIG (signed by TLD key)

' Step 2 - Get DNSKEY from child zone
Resolver -> Authoritative : Query DNSKEY for "example.com"
Authoritative --> Resolver : DNSKEY + RRSIG (signed by zone key)

note over Resolver
Validate DNSKEY using DS from TLD.  
Root trust anchor ‚Üí TLD ‚Üí Authoritative zone.  
If mismatch ‚Üí reject response.
end note

' Step 3 - Query actual record
Resolver -> Authoritative : Query A for "example.com"
Authoritative --> Resolver : A record + RRSIG

note over Resolver
Verify A record using DNSKEY + RRSIG.  
If valid ‚Üí accept.  
If invalid ‚Üí discard.
end note

Resolver --> User : Return validated DNS record (IP for example.com)
@enduml
  </script>
</div>

<h3 id="section-6-6-route53-resolver-endpoints">6.6 Route 53 Resolver and Endpoints</h3>

<p>By default, every <strong>VPC</strong> has an <strong>Amazon-managed DNS resolver</strong> at the reserved IP <code class="language-plaintext highlighter-rouge">VPC-CIDR+.2</code> (e.g., <code class="language-plaintext highlighter-rouge">10.0.0.2</code>).</p>
<ul>
  <li>Accessible from <strong>all subnets</strong> in the VPC.</li>
  <li>Resolves <strong>public DNS records</strong> and <strong>private hosted zones</strong> linked to the VPC.</li>
  <li>No setup required ‚Äî it‚Äôs built-in.</li>
</ul>

<p>üëâ Limitation: The default <code class="language-plaintext highlighter-rouge">.2</code> resolver only works <strong>inside the VPC</strong>. It cannot be queried from on-premises networks or other VPCs directly.</p>

<p>To integrate DNS across hybrid or multi-VPC environments, AWS provides <strong>Route 53 Resolver Endpoints</strong>:</p>

<ul>
  <li><strong>Inbound Endpoint</strong>:
    <ul>
      <li>On-premises DNS servers ‚Üí query AWS <code class="language-plaintext highlighter-rouge">.2</code> resolver via an ENI in the VPC.</li>
    </ul>
  </li>
  <li><strong>Outbound Endpoint</strong>:
    <ul>
      <li>VPC resources ‚Üí forward queries to on-premises DNS servers.</li>
    </ul>
  </li>
</ul>

<p>These endpoints solve the <strong>DNS boundary problem</strong> where VPC and on-prem DNS could not previously resolve each other.</p>

<div class="image-wrapper">
  <img src="./assets/route53_resolver_flow.png" alt="Route 53 Resolver Endpoints Flow" class="modal-trigger" data-caption="Route 53 Resolver inbound and outbound flow between on-premises and AWS VPC" />
  <div class="diagram-caption" data-snippet-id="resolver-snippet">
    üîÑ Route 53 Resolver ‚Äì Inbound &amp; Outbound Endpoint Flow
  </div>
  <script type="text/plain" id="resolver-snippet">
@startuml
title Route 53 Resolver Endpoints Flow

participant OnPremDNS as "On-Premises DNS Server"
participant Inbound as "Route 53 Resolver Inbound Endpoint (VPC ENI)"
participant Resolver as "VPC .2 Resolver (Amazon-managed)"
participant Outbound as "Route 53 Resolver Outbound Endpoint (VPC ENI)"
participant CorpDNS as "On-Premises Corporate DNS"
participant EC2 as "VPC Resource (EC2/Lambda)"

== Inbound Query (On-Prem ‚Üí VPC/.2) ==
OnPremDNS -> Inbound : DNS Query "db.aws.local"
Inbound -> Resolver : Forward to .2 Resolver
Resolver --> Inbound : Resolve record (private/public zone)
Inbound --> OnPremDNS : Return DNS answer

== Outbound Query (VPC ‚Üí On-Prem) ==
Resolver -> Outbound : Forward query "corp.local"
Outbound -> CorpDNS : Send DNS request
CorpDNS --> Outbound : Return corporate record
Outbound --> Resolver : Forward answer to .2
Resolver --> EC2 : Deliver response to VPC resource

@enduml
  </script>
</div>

<hr />

<h2 id="section-7-ipv6-in-aws">7. IPv6 in AWS</h2>

<p>AWS VPCs support <strong>dual-stack networking</strong> (IPv4 + IPv6). Unlike IPv4, IPv6 is <strong>globally unique and publicly routable</strong>, which removes the need for NAT but requires careful access control.</p>

<h3 id="section-7-1-key-points">7.1 Key Points</h3>

<ul>
  <li><strong>CIDR Allocation</strong>:
    <ul>
      <li>Each VPC gets an <strong>Amazon-provided /56 IPv6 block</strong>.</li>
      <li>Each subnet automatically receives a <strong>/64 range</strong> (one per subnet, up to 256 subnets per VPC).</li>
    </ul>
  </li>
  <li><strong>Routing</strong>:
    <ul>
      <li>IPv6 routes appear separately in route tables alongside IPv4 routes.</li>
      <li>Works with the same routing constructs (IGW, TGW, VGW, etc.), but must be explicitly added.</li>
    </ul>
  </li>
  <li><strong>Gateways</strong>:
    <ul>
      <li><strong>Internet Gateway (IGW)</strong> ‚Üí allows <strong>bidirectional IPv4 + IPv6</strong>.</li>
      <li><strong>Egress-Only IGW</strong> ‚Üí outbound-only for IPv6 (blocks unsolicited inbound).</li>
    </ul>
  </li>
  <li><strong>Service Support</strong>:
    <ul>
      <li>Must be enabled per VPC, subnet, and ENI.</li>
      <li>Not all AWS services support IPv6 (check service docs before enabling).</li>
    </ul>
  </li>
  <li><strong>No NAT Needed</strong>:
    <ul>
      <li>NAT Gateway is not required for IPv6 since all IPv6 addresses are globally routable. For IPv4, a NAT Gateway is needed because of address space limitations and the use of address masquerading (NAT) to share public IPs.</li>
      <li>Security relies on <strong>Security Groups / NACLs</strong> instead of NAT hiding.</li>
    </ul>
  </li>
</ul>

<h3 id="section-7-2-considerations">7.2 Considerations</h3>

<ul>
  <li>Plan dual-stack carefully: some workloads may remain IPv4-only.</li>
  <li>Use <strong>Egress-Only IGW</strong> to protect IPv6 workloads from unsolicited inbound traffic.</li>
  <li>Validate which AWS services support IPv6 before rollout (e.g., some managed services may lag behind).</li>
  <li>IPv6 helps with <strong>address exhaustion</strong> but introduces new <strong>security + monitoring challenges</strong>.</li>
</ul>

<p>‚ö° <strong>Takeaway</strong>:<br />
IPv6 in AWS = <strong>globally routable addresses, no NAT, /56 per VPC, /64 per subnet, explicit routing, and egress-only IGW for outbound-only control</strong>.</p>

    </article>
  </main>

  <div id="imageModal" class="image-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <button class="modal-nav modal-prev">&#8249;</button>
    <button class="modal-nav modal-next">&#8250;</button>
    <img id="modalImage" src="" alt="">
    <div id="modalCaption"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  const modalCaption = document.getElementById('modalCaption');
  const modalClose = document.querySelector('.modal-close');
  const modalPrev = document.querySelector('.modal-prev');
  const modalNext = document.querySelector('.modal-next');

  let modalImages = [];
  let currentIndex = -1;
  let currentScale = 1;
  const scaleFactor = 0.1;

  function refreshModalImages() {
    modalImages = Array.from(document.querySelectorAll('.modal-trigger'));
  }

  function updateImageTransform() {
    modalImg.style.transform = `scale(${currentScale})`;
    modalImg.style.transition = 'transform 0.1s ease';
  }

  function openModalAtIndex(index) {
    if (!modalImages.length) {
      return;
    }

    if (index < 0) {
      index = modalImages.length - 1;
    } else if (index >= modalImages.length) {
      index = 0;
    }

    currentIndex = index;
    const target = modalImages[currentIndex];
    if (!target) {
      return;
    }

    const src = target.dataset.modalSrc || target.src;
    const caption = target.getAttribute('data-caption') || target.alt;

    modalImg.src = src;
    modalCaption.textContent = caption || '';
    modal.classList.add('show');
    currentScale = 1;
    updateImageTransform();
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modal.classList.remove('show');
    document.body.style.overflow = '';
    currentScale = 1;
    currentIndex = -1;
    delete modal.dataset.initialDistance;
  }

  refreshModalImages();

  document.addEventListener('click', function(e) {
    if (!e.target.classList.contains('modal-trigger')) {
      return;
    }

    if (!modalImages.length) {
      refreshModalImages();
    }

    let index = modalImages.indexOf(e.target);
    if (index === -1) {
      refreshModalImages();
      index = modalImages.indexOf(e.target);
    }

    if (index === -1) {
      return;
    }

    openModalAtIndex(index);
  });

  modalClose.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (!modal.classList.contains('show')) {
      return;
    }

    switch (e.key) {
      case 'Escape':
        closeModal();
        break;
      case 'ArrowLeft':
        e.preventDefault();
        openModalAtIndex(currentIndex - 1);
        break;
      case 'ArrowRight':
        e.preventDefault();
        openModalAtIndex(currentIndex + 1);
        break;
      case '+':
      case '=':
        e.preventDefault();
        currentScale = Math.min(currentScale + scaleFactor, 3);
        updateImageTransform();
        break;
      case '-':
        e.preventDefault();
        currentScale = Math.max(currentScale - scaleFactor, 0.1);
        updateImageTransform();
        break;
      case '0':
        e.preventDefault();
        currentScale = 1;
        updateImageTransform();
        break;
    }
  });

  modal.addEventListener('wheel', function(e) {
    if (!modal.classList.contains('show')) {
      return;
    }

    e.preventDefault();
    const delta = e.deltaY > 0 ? -scaleFactor : scaleFactor;
    currentScale = Math.max(0.1, Math.min(3, currentScale + delta));
    updateImageTransform();
  }, { passive: false });

  if (modalPrev) {
    modalPrev.addEventListener('click', function(e) {
      e.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex - 1);
    });
  }

  if (modalNext) {
    modalNext.addEventListener('click', function(e) {
      e.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex + 1);
    });
  }

  modal.addEventListener('touchstart', function(e) {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (e.touches.length === 2) {
      const [touch1, touch2] = e.touches;
      modal.dataset.initialDistance = Math.hypot(
        touch1.clientX - touch2.clientX,
        touch1.clientY - touch2.clientY
      );
    } else {
      e.preventDefault();
    }
  }, { passive: false });

  modal.addEventListener('touchmove', function(e) {
    if (!modal.classList.contains('show') || e.touches.length !== 2) {
      return;
    }

    e.preventDefault();
    const [touch1, touch2] = e.touches;
    const currentDistance = Math.hypot(
      touch1.clientX - touch2.clientX,
      touch1.clientY - touch2.clientY
    );
    const initialDistance = parseFloat(modal.dataset.initialDistance || '0');
    if (initialDistance > 0) {
      const scaleChange = (currentDistance - initialDistance) / initialDistance;
      currentScale = Math.max(0.1, Math.min(3, currentScale + scaleChange * 0.5));
      updateImageTransform();
      modal.dataset.initialDistance = currentDistance;
    }
  }, { passive: false });
});

// PlantUML Hover Tooltip functionality
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('[data-snippet-id]').forEach(function(caption) {
    const snippetId = caption.getAttribute('data-snippet-id');
    const snippetElement = document.getElementById(snippetId);

    if (snippetElement) {
      const content = snippetElement.textContent.replace(/"/g, '&quot;');
      caption.setAttribute('data-tooltip', content);
      caption.classList.add('diagram-caption');
    }
  });
});
</script>


  <!-- Floating Table of Contents -->
  <div id="floating-toc" class="floating-toc">
    <div class="toc-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
    </div>
    <div class="toc-content">
      <div class="toc-header">
        <span>Contents</span>
        <button class="toc-close" aria-label="Close table of contents">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <nav class="toc-nav" id="toc-nav">
        <!-- Generated by JavaScript -->
      </nav>
    </div>
  </div>

  <footer class="site-footer">
    <span>¬© 2025 glucolte ‚Ä¢ </span>
    <a href="https://github.com/gLuColte/glucolte.github.io">source</a>
  </footer>

  <script>
    // Dark mode functionality
    function initDarkMode() {
      const toggle = document.getElementById('dark-mode-toggle');
      const body = document.body;
      
      // Check for saved theme preference or default to light mode
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        body.setAttribute('data-theme', 'dark');
      }
      
      // Toggle dark mode
      if (toggle) {
        toggle.addEventListener('click', function() {
          const currentTheme = body.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          body.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      }
    }
    
    // Initialize dark mode immediately to prevent flash
    initDarkMode();
    
    // Initialize highlight.js and floating TOC after the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      hljs.highlightAll();
      
      // Floating TOC functionality - only show on sub-study pages
      const floatingToc = document.getElementById('floating-toc');
      const tocNav = document.getElementById('toc-nav');
      const tocClose = document.querySelector('.toc-close');
      
      // Check if we're on a sub-study page (not the main study index)
      const isSubStudyPage = window.location.pathname !== '/study/' && 
                            window.location.pathname !== '/study' && 
                            window.location.pathname.startsWith('/study/');
      
      if (floatingToc && tocNav && isSubStudyPage) {
        // Generate TOC from headings
        function generateTOC() {
          const headings = document.querySelectorAll('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6');
          if (headings.length === 0) {
            floatingToc.style.display = 'none';
            return;
          }
          
          const tocList = document.createElement('ul');
          let currentLevel = 0;
          let currentList = tocList;
          const listStack = [tocList];
          
          headings.forEach((heading, index) => {
            const level = parseInt(heading.tagName.charAt(1));
            const id = heading.id || `heading-${index}`;
            
            // Ensure heading has an ID
            if (!heading.id) {
              heading.id = id;
            }
            
            // Create list item
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = `#${id}`;
            link.textContent = heading.textContent.trim();
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const targetElement = document.getElementById(id);
              if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Close TOC after clicking
                floatingToc.classList.remove('toc-open');
              }
            });
            
            listItem.appendChild(link);
            
            // Handle nesting
            if (level > currentLevel) {
              // Go deeper
              for (let i = currentLevel; i < level; i++) {
                const newList = document.createElement('ul');
                currentList.appendChild(newList);
                listStack.push(newList);
                currentList = newList;
              }
            } else if (level < currentLevel) {
              // Go shallower
              for (let i = currentLevel; i > level; i--) {
                listStack.pop();
                currentList = listStack[listStack.length - 1];
              }
            }
            
            currentList.appendChild(listItem);
            currentLevel = level;
          });
          
          tocNav.appendChild(tocList);
        }
        
        // Generate the TOC
        generateTOC();
        
        // Handle close button
        if (tocClose) {
          tocClose.addEventListener('click', function() {
            floatingToc.classList.remove('toc-open');
          });
        }
        
        // Handle click on icon to toggle
        const tocIcon = document.querySelector('.toc-icon');
        if (tocIcon) {
          tocIcon.addEventListener('click', function() {
            floatingToc.classList.toggle('toc-open');
          });
        }
        
        // Active section highlighting
        function updateActiveSection() {
          const headings = document.querySelectorAll('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6');
          const tocLinks = tocNav.querySelectorAll('a');
          
          // Remove active class from all links
          tocLinks.forEach(link => link.classList.remove('active'));
          
          // Find the current section
          let currentHeading = null;
          const scrollPosition = window.scrollY + 100; // Offset for better UX
          
          for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            const headingTop = heading.offsetTop;
            
            if (headingTop <= scrollPosition) {
              currentHeading = heading;
              break;
            }
          }
          
          // Add active class to current section
          if (currentHeading) {
            const activeLink = tocNav.querySelector(`a[href="#${currentHeading.id}"]`);
            if (activeLink) {
              activeLink.classList.add('active');
            }
          }
        }
        
        // Update active section on scroll
        let scrollTimeout;
        window.addEventListener('scroll', function() {
          if (scrollTimeout) {
            clearTimeout(scrollTimeout);
          }
          scrollTimeout = setTimeout(updateActiveSection, 10);
        });
        
        // Initial update
        updateActiveSection();
      } else if (floatingToc && !isSubStudyPage) {
        // Hide floating TOC on main study page
        floatingToc.style.display = 'none';
      }
      
      // Legacy TOC functionality (for existing markdown TOCs)
      const toc = document.querySelector('#markdown-toc');
      if (toc) {
        // Hide the floating TOC if there's already a markdown TOC
        if (floatingToc) {
          floatingToc.style.display = 'none';
        }
        
        // Create TOC container with header
        const tocContainer = document.createElement('div');
        tocContainer.className = 'toc-container';
        tocContainer.style.cssText = `
          background: #f8fafc;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 16px;
          margin: 20px 0;
          position: relative;
        `;
        
        // Add TOC header
        const tocHeader = document.createElement('h3');
        tocHeader.textContent = 'Table of Contents';
        tocHeader.style.cssText = `
          margin: 0 0 12px 0;
          font-size: 16px;
          font-weight: 600;
          color: #374151;
        `;
        
        // Add back to top button
        const backToTopBtn = document.createElement('button');
        backToTopBtn.textContent = '‚Üë Top';
        backToTopBtn.style.cssText = `
          position: absolute;
          top: 12px;
          right: 12px;
          background: #ffffff;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          padding: 4px 8px;
          font-size: 12px;
          cursor: pointer;
          color: #6b7280;
          transition: all 0.2s ease;
        `;
        
        // Add hover effect for back to top button
        backToTopBtn.addEventListener('mouseenter', function() {
          this.style.background = '#f3f4f6';
          this.style.color = '#374151';
        });
        
        backToTopBtn.addEventListener('mouseleave', function() {
          this.style.background = '#ffffff';
          this.style.color = '#6b7280';
        });
        
        // Back to top functionality
        backToTopBtn.addEventListener('click', function() {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Style the TOC list
        toc.style.cssText = `
          margin: 0;
          padding: 0;
          font-size: 14px;
          line-height: 1.5;
        `;
        
        // Insert header and button into container
        tocContainer.appendChild(tocHeader);
        tocContainer.appendChild(backToTopBtn);
        tocContainer.appendChild(toc);
        
        // Replace the original TOC with the new container
        toc.parentNode.insertBefore(tocContainer, toc);
        tocContainer.appendChild(toc);
        
        // Add smooth scrolling to TOC links
        const tocLinks = toc.querySelectorAll('a');
        tocLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: 'smooth' });
            }
          });
        });
      }
    });
  </script>
</body>
</html>
