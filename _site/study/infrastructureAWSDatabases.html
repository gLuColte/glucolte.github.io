<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AWS Database Services ¬∑ glucolte</title>
  <meta name="description" content="notes ‚Ä¢ principles ‚Ä¢ systems">
  <link rel="stylesheet" href="/assets/style.css">
  <link rel="stylesheet" href="/assets/study.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AWS Database Services | glucolte</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="AWS Database Services" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="notes ‚Ä¢ principles ‚Ä¢ systems" />
<meta property="og:description" content="notes ‚Ä¢ principles ‚Ä¢ systems" />
<link rel="canonical" href="http://localhost:4000/study/infrastructureAWSDatabases" />
<meta property="og:url" content="http://localhost:4000/study/infrastructureAWSDatabases" />
<meta property="og:site_name" content="glucolte" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AWS Database Services" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"notes ‚Ä¢ principles ‚Ä¢ systems","headline":"AWS Database Services","url":"http://localhost:4000/study/infrastructureAWSDatabases"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="site-header">
  <a class="brand" href="/">glucolte</a>
  <nav class="nav">
    <a href="/principles">principles</a>
    <a href="/rules">rules</a>
    <a href="/stretches">stretches</a>
    <a href="/study/">study</a>
    <a href="/projects/">projects</a>
    <a href="/setup/">setup</a>
  </nav>
  <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
    <svg class="sun-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
    <svg class="moon-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>
</header>


  <main class="container">
    <article class="content">
      <h2 id="section-1-amazon-rds-foundations">1. Amazon RDS Foundations</h2>

<p>Amazon Relational Database Service automates provisioning, patching, and backups for managed engines (MySQL, PostgreSQL, MariaDB, SQL Server, Oracle). Key building blocks:</p>

<ul>
  <li><strong>Subnet groups</strong> span multiple AZs and determine where instances launch.</li>
  <li><strong>CNAME endpoints</strong> abstract the current primary; applications connect via DNS rather than fixed IPs.</li>
  <li>Instances can host multiple databases and use dedicated EBS storage (SSD or HDD).</li>
</ul>

<h3 id="section-1-1-multi-az">1.1 Multi-AZ Deployments</h3>

<p><strong>Instance-based Multi-AZ</strong></p>
<ul>
  <li>Primary + single standby in different AZs.</li>
  <li>Synchronous, storage-level replication; commits succeed only after both copies persist.</li>
  <li>Standby is passive. Applications always point at the CNAME of the primary. When the primary fails (planned or unplanned) DNS is updated to the standby‚Äôs IP. Expect 60‚Äì120 seconds of failover while the database process restarts and clients refresh DNS.</li>
  <li>Best for traditional engines that do not need read-scale but do need durable writes and automatic backups.</li>
</ul>

<p><strong>Cluster-based Multi-AZ</strong></p>
<ul>
  <li>One writer and up to two readers across AZs.</li>
  <li>Synchronous log-based replication; commit waits for at least one reader to persist the change. Because each node runs its own instance, readers can be promoted quickly if the writer fails.</li>
  <li>Provides a <strong>reader endpoint</strong> that automatically load balances SELECT traffic, plus <strong>instance endpoints</strong> for targeted testing.</li>
  <li>Failover is typically ~35 seconds plus transaction-log catch-up, delivering faster RTO than instance-based Multi-AZ while allowing some read scaling.</li>
</ul>

<h3 id="section-1-2-read-replicas">1.2 Read Replicas</h3>

<ul>
  <li>Asynchronous replication (optional in addition to Multi-AZ) that operates at the storage/transaction-log layer.</li>
  <li>Up to 5 replicas per instance; replicas can cascade (replica of replica) but each additional hop introduces lag, so keep the tree shallow.</li>
  <li>Common patterns:
    <ul>
      <li><strong>Scale-out reads</strong> ‚Äì point BI/reporting jobs or API readers to read replica endpoints.</li>
      <li><strong>Cross-Region DR</strong> ‚Äì place replicas in other regions for near-zero RPO and promote during regional outages.</li>
      <li><strong>Blue/Green cutovers</strong> ‚Äì promote a replica after schema upgrades instead of restoring from snapshot.</li>
    </ul>
  </li>
  <li>Promotion is a fast, push-button operation: replica becomes a standalone primary with its own endpoint. Because replication is asynchronous, treat it as DR for outages‚Äînot for logical corruption, which would replicate to replicas immediately.</li>
</ul>

<h3 id="section-1-3-backups">1.3 Backups, Snapshots, Restores</h3>

<ul>
  <li><strong>Automated backups</strong> (disabled by default) capture daily snapshots plus 5-minute transaction log uploads to S3; RPO ‚âà 5 minutes, retention 0‚Äì35 days, can replicate cross-region.</li>
  <li><strong>Manual snapshots</strong> persist until deleted; first snapshot is full, subsequent are incremental.</li>
  <li>Restores always create new instances with new endpoints; point-in-time restores replay logs from the automated backup window.</li>
</ul>

<h3 id="section-1-4-security-cost">1.4 Security and Cost</h3>

<ul>
  <li>TLS/SSL available for in-transit encryption; at-rest encryption uses KMS-backed EBS volumes (irreversible once enabled).</li>
  <li>Oracle and SQL Server support Transparent Data Encryption (TDE); Oracle can integrate with CloudHSM for customer-controlled keys.</li>
  <li>IAM database authentication issues 15-minute tokens mapped to DB users, reducing static credential use.</li>
  <li>Cost factors: instance class, Multi-AZ, storage type/capacity, data transfer, backup storage, and bring-your-own-license options.</li>
</ul>

<hr />

<h2 id="section-2-amazon-aurora">2. Amazon Aurora</h2>

<h3 id="section-2-1-architecture">2.1 Architecture</h3>

<ul>
  <li>Aurora decouples compute and storage via a 128 TiB shared cluster volume with six copies across three AZs.</li>
  <li>Primary writer sends log records to the storage subsystem; replicas read from the same volume, enabling fast failover.</li>
  <li>Endpoints:
    <ul>
      <li><strong>Cluster endpoint</strong> ‚Äì connects to the primary writer.</li>
      <li><strong>Reader endpoint</strong> ‚Äì load balances across replicas.</li>
      <li><strong>Instance endpoints</strong> ‚Äì direct to a specific instance (useful for testing and fault isolation).</li>
    </ul>
  </li>
  <li>Storage auto-scales; billing covers actual GB-month plus I/O.</li>
</ul>

<h3 id="section-2-2-operations">2.2 Operations</h3>

<ul>
  <li>Restores/spin-ups create new clusters; backtrack enables rewinding to a prior timestamp without snapshots (useful for logical corruption).</li>
  <li>Fast database cloning copies metadata and shares data pages, only duplicating changed pages.</li>
  <li>No free tier; micro instances not supported. Aurora often costs less than RDS when factoring multi-AZ throughput per dollar.</li>
</ul>

<h3 id="section-2-3-aurora-serverless">2.3 Aurora Serverless v2</h3>

<ul>
  <li>Removes instance management; capacity measured in Aurora Capacity Units (ACUs).</li>
  <li>Proxy fleet handles connections while compute scales between configured min/max ACUs and can pause when idle.</li>
  <li>Ideal for infrequently used applications, new workloads with unknown sizing, multi-tenant SaaS, or dev/test clusters.</li>
</ul>

<h3 id="section-2-4-aurora-multi-master">2.4 Aurora Multi-Master</h3>

<ul>
  <li>Multiple read/write instances; clients can connect to any writer endpoint.</li>
  <li>Storage-level replication ensures cross-AZ durability. Last-writer-wins conflict resolution when concurrent writes touch the same rows.</li>
  <li>Eliminates DNS failover delays: if one writer fails, connections continue against remaining writers.</li>
</ul>

<hr />

<h2 id="section-3-rds-proxy-custom">3. RDS Proxy &amp; RDS Custom</h2>

<h3 id="section-3-1-rds-proxy">3.1 RDS Proxy</h3>

<ul>
  <li>Managed connection pooling layer sitting in your VPC between applications and RDS/Aurora.</li>
  <li>Maintains a warm pool of database connections, multiplexes client requests, and reduces failover times by up to 50%.</li>
  <li>Enforce TLS, integrate with IAM auth, and smooth out connection storms (e.g., Lambda functions opening/closing frequently).</li>
  <li>Recommended when hitting connection limits, running burstable t-class DB instances, or using serverless compute against RDS.</li>
</ul>

<h3 id="section-3-2-rds-custom">3.2 RDS Custom</h3>

<ul>
  <li>Bridges the gap between fully managed RDS and self-managed EC2 databases.</li>
  <li>Available for Oracle and SQL Server; provides SSH/RDP/Session Manager access to the underlying host to install agents, customize OS settings, or meet strict compliance.</li>
  <li>Automation can be paused (‚Äúpause and customize‚Äù) during changes, then resumed for managed backups/patching.</li>
</ul>

<div class="image-wrapper">
  <img src="./assets/rds_responsibilities.png" alt="rds-responsibilities" class="modal-trigger" data-caption="üß© RDS Responsibilities" />
  <div class="diagram-caption" data-snippet-id="rds-responsibilities">
    üß© RDS Responsibilities
  </div>
  <script type="text/plain" id="rds-responsibilities">
flowchart TB

%% ------------------ RESPONSIBILITY LEGEND ------------------
subgraph LEGEND["Responsibility Legend"]
    CUST["üîµ Customer"]
    SHARED["üü£ Shared"]
    AWS["üü† AWS"]
end

%% ------------------ ON-PREMISES ------------------
subgraph ONPREM["On-Premises"]
    OPT_OP("üîµ Optimization")
    SC_OP("üîµ Scaling")
    HA_OP("üîµ High Availability")
    BK_OP("üîµ Backups")
    DBP_OP("üîµ DB Patching")
    OSP_OP("üîµ OS Patch")
    OSI_OP("üîµ OS Install/Setup")
    HW_OP("üîµ Hardware")
end

%% ------------------ RDS (Fully Managed) ------------------
subgraph RDS["Amazon RDS"]
    OPT_R("üîµ Optimization")
    SC_R("üü† Scaling")
    HA_R("üü† High Availability")
    BK_R("üü† Backups")
    DBP_R("üü† DB Patching")
    OSP_R("üü† OS Patch")
    OSI_R("üü† OS Install/Setup")
    HW_R("üü† Hardware")
end

%% ------------------ RDS CUSTOM ------------------
subgraph RDSC["RDS Custom"]
    OPT_RC("üîµ Optimization")
    SC_RC("üü£ Scaling")
    HA_RC("üü£ High Availability")
    BK_RC("üü£ Backups")
    DBP_RC("üü£ DB Patching")
    OSP_RC("üü£ OS Patch")
    OSI_RC("üü£ OS Install/Setup")
    HW_RC("üü† Hardware")
end

%% ------------------ EC2 ------------------
subgraph EC2["Database on EC2"]
    OPT_E("üîµ Optimization")
    SC_E("üîµ Scaling")
    HA_E("üîµ High Availability")
    BK_E("üîµ Backups")
    DBP_E("üîµ DB Patching")
    OSP_E("üîµ OS Patch")
    OSI_E("üîµ OS Install/Setup")
    HW_E("üü† Hardware")
end
  </script>
</div>
<hr />

<h2 id="section-4-amazon-dynamodb">4. Amazon DynamoDB</h2>

<h3 id="section-4-1-table-model">4.1 Table Model &amp; Capacity</h3>

<ul>
  <li>Key-value and document store with single-digit millisecond latency backed by SSDs and automatic AZ replication.</li>
  <li>Tables consist of items keyed by a partition key (PK) or composite key (PK + sort key). Items can vary in attributes but max out at 400 KB, allowing sparse schemas.</li>
  <li>Capacity controls throughput (not storage). Units:
    <ul>
      <li><strong>1 RCU</strong> = one strongly consistent read of 4 KB/sec (eventual consistency halves RCU consumption).</li>
      <li><strong>1 WCU</strong> = one 1 KB write/sec.</li>
    </ul>
  </li>
  <li>Burst capacity: unused throughput accumulates for up to 300 seconds.</li>
  <li>Provisioned mode sets fixed RCUs/WCUs; on-demand mode bills per million read/write units without upfront planning.</li>
  <li><strong>Sizing example:</strong> storing 10 items per second averaging 2.5 KB requires <code class="language-plaintext highlighter-rouge">ceil(2.5 KB / 1 KB) = 3 WCUs</code> per item √ó 10 writes = <strong>30 WCUs</strong>. Similar logic applies to reads, using 4 KB increments.</li>
</ul>

<h3 id="section-4-2-backups">4.2 Backups &amp; PITR</h3>

<ul>
  <li>On-demand backups snapshot tables (with or without indexes) and restore into same/cross regions with new encryption settings.</li>
  <li>Point-in-time recovery (disabled by default) records incremental changes for 35 days with 1-second granularity; enables rewind to any point in that window.</li>
</ul>

<h3 id="section-4-3-query-scan">4.3 Query vs. Scan</h3>

<ul>
  <li><strong>Query</strong> operates on a single partition key (optionally sort key ranges); consumed capacity equals all returned items before filters.</li>
  <li><strong>Scan</strong> walks every item (or a segment) regardless of keys; flexible but expensive in RCUs. Use filters sparingly‚Äîcapacity is still spent.</li>
</ul>

<h3 id="section-4-4-consistency">4.4 Consistency Models</h3>

<ul>
  <li>Data replicates to multiple AZs with a leader managing writes.</li>
  <li>Eventual consistency (default) returns results that may be up to one second stale but consumes half the RCUs.</li>
  <li>Strong consistency reads from the leader for the latest committed data.</li>
</ul>

<h3 id="section-4-5-indexes">4.5 Secondary Indexes</h3>

<ul>
  <li><strong>Local Secondary Index (LSI)</strong> ‚Äì alternate sort key on the same partition key; must be created with the table, up to five LSIs, shares RCUs/WCUs, supports strong consistency. Great for multiple chronological views of the same customer/account.</li>
  <li><strong>Global Secondary Index (GSI)</strong> ‚Äì alternate partition and sort keys; can be added later, each with its own RCUs/WCUs, defaults to eventual consistency (strong reads only in same region). Enables ‚Äúquery by anything else‚Äù patterns such as email, status, or composite attributes.</li>
  <li>Remember that GSIs consume their own capacity. Monitor <code class="language-plaintext highlighter-rouge">ConsumedReadCapacityUnits</code>/<code class="language-plaintext highlighter-rouge">ConsumedWriteCapacityUnits</code> metrics per index to avoid throttling.</li>
</ul>

<h3 id="section-4-6-streams">4.6 Streams &amp; Triggers</h3>

<ul>
  <li>Streams capture ordered inserts/updates/deletes with 24-hour retention; enable on a per-table basis and choose image format (keys only, new, old, new+old).</li>
  <li>Common pattern: Streams + Lambda to react to data changes for analytics, notifications, or search indexing.</li>
</ul>

<h3 id="section-4-7-dax">4.7 DynamoDB Accelerator (DAX)</h3>

<ul>
  <li>Managed in-memory cache for DynamoDB; deployed inside a VPC across AZs. Think of it as a fully managed Redis-tier dedicated to DynamoDB traffic.</li>
  <li>Applications use the DAX SDK; cache handles GetItem/Query results, reducing DynamoDB calls from milliseconds to microseconds and shielding tables from read bursts.</li>
  <li>Cluster architecture:
    <ul>
      <li>Primary node handles writes and cache population.</li>
      <li>Replicas serve read traffic; failover promotes a replica without client-side changes.</li>
      <li>Item cache stores GetItem results; query cache stores Query/Scan responses keyed by parameters.</li>
    </ul>
  </li>
  <li>Supports write-through (cache updated on write) and write-around (only reads populate cache) policies.</li>
</ul>

<h3 id="section-4-8-global-tables-ttl">4.8 Global Tables &amp; TTL</h3>

<ul>
  <li><strong>Global Tables</strong> replicate tables across regions in an active-active fashion (last-writer-wins conflict resolution). Reads/writes in any region replicate in seconds. Strong consistency only available within the Region where the write occurred.</li>
  <li><strong>Time to Live (TTL)</strong> marks per-item expiry timestamps; DynamoDB removes expired items without consuming WCUs. Streams can capture deletions for auditing.</li>
</ul>

<hr />

<h2 id="section-5-analytics-specialty">5. Analytics &amp; Specialty Databases</h2>

<h3 id="section-5-1-opensearch">5.1 Amazon OpenSearch Service (formerly Elasticsearch)</h3>

<ul>
  <li>Managed deployment of the ELK stack components (OpenSearch, Kibana, optional Logstash).</li>
  <li>Useful when organizations already rely on Elasticsearch for log analytics, full-text search, or observability dashboards.</li>
  <li>Offers integration with VPCs, fine-grained access control, and automated cluster management.</li>
</ul>

<h3 id="section-5-2-athena">5.2 Amazon Athena</h3>

<ul>
  <li>Serverless SQL queries against data in S3 using schema-on-read (Glue Data Catalog).</li>
  <li>Pay per TB scanned; supports structured (CSV, Parquet), semi-structured (JSON), and direct querying of AWS service logs (CloudTrail, ELB, VPC Flow Logs).</li>
  <li>Great for ad-hoc analytics, log exploration, and low-cost reporting without ETL pipelines.</li>
</ul>

<h3 id="section-5-3-neptune">5.3 Amazon Neptune</h3>

<ul>
  <li>Managed graph database supporting property graphs (Gremlin, openCypher) and RDF/SPARQL.</li>
  <li>VPC-only deployment, Multi-AZ failover, and read replicas for scale.</li>
  <li>Continuous backups to S3; suited for knowledge graphs, fraud graphs, and relationship-heavy workloads.</li>
</ul>

<h3 id="section-5-4-qldb">5.4 Amazon QLDB</h3>

<ul>
  <li>Immutable, append-only ledger database with cryptographically verifiable transaction log.</li>
  <li>Serverless; replicates across three AZs and exposes full history for auditing.</li>
  <li>Ideal for financial systems of record, supply-chain tracking, and compliance-sensitive logs.</li>
  <li>Streams can feed Kinesis for downstream processing.</li>
</ul>

<hr />

<h2 id="section-6-exam-reminders">6. Exam Reminders</h2>

<ul>
  <li><strong>RDS snapshots</strong> ‚Äì stored in S3 for point-in-time recovery; replicating or promoting cross-Region replicas triggers a reboot. Deletion protection guards against accidental deletes but does not replace backups.</li>
  <li><strong>Redshift snapshots</strong> ‚Äì when copying encrypted snapshots cross-Region, create a snapshot copy grant referencing the destination CMK.</li>
  <li><strong>Aurora fast restart</strong> ‚Äì buffer cache lives outside the database process so restarts avoid lengthy redo replay; typical restart times are under a minute.</li>
</ul>

<hr />

    </article>
  </main>

  <div id="imageModal" class="image-modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <button class="modal-nav modal-prev">&#8249;</button>
    <button class="modal-nav modal-next">&#8250;</button>
    <img id="modalImage" src="" alt="">
    <div id="modalCaption"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  const modalCaption = document.getElementById('modalCaption');
  const modalClose = document.querySelector('.modal-close');
  const modalPrev = document.querySelector('.modal-prev');
  const modalNext = document.querySelector('.modal-next');

  const SCALE_STEP = 0.2;
  const MIN_SCALE = 1;
  const MAX_SCALE = 3;

  let modalImages = [];
  let currentIndex = -1;
  let currentScale = MIN_SCALE;
  let translateX = 0;
  let translateY = 0;
  let isDragging = false;
  let isTouchDragging = false;
  let isPinching = false;
  let dragStartX = 0;
  let dragStartY = 0;
  let pinchStartDistance = 0;
  let pinchStartScale = MIN_SCALE;
  let transitionTimeout;

  function refreshModalImages() {
    modalImages = Array.from(document.querySelectorAll('.modal-trigger'));
  }

  function applyTransform(withTransition = false) {
    if (currentScale <= MIN_SCALE) {
      currentScale = MIN_SCALE;
      translateX = 0;
      translateY = 0;
    }

    if (transitionTimeout) {
      clearTimeout(transitionTimeout);
      transitionTimeout = null;
    }

    modalImg.style.transition = withTransition ? 'transform 0.15s ease' : 'none';
    modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
    modalImg.style.cursor = currentScale > MIN_SCALE
      ? (isDragging || isTouchDragging ? 'grabbing' : 'grab')
      : 'auto';

    if (withTransition) {
      transitionTimeout = setTimeout(() => {
        modalImg.style.transition = 'none';
      }, 160);
    }
  }

  function resetTransform() {
    currentScale = MIN_SCALE;
    translateX = 0;
    translateY = 0;
    applyTransform(false);
  }

  function getDistance(touch1, touch2) {
    return Math.hypot(
      touch1.clientX - touch2.clientX,
      touch1.clientY - touch2.clientY
    );
  }

  function openModalAtIndex(index) {
    refreshModalImages();

    if (!modalImages.length) {
      return;
    }

    if (index < 0) {
      index = modalImages.length - 1;
    } else if (index >= modalImages.length) {
      index = 0;
    }

    const target = modalImages[index];
    if (!target) {
      return;
    }

    currentIndex = index;
    const src = target.dataset.modalSrc || target.src;
    const caption = target.getAttribute('data-caption') || target.alt;

    modalImg.src = src;
    modalCaption.textContent = caption || '';
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    resetTransform();
  }

  function closeModal() {
    if (!modal.classList.contains('show')) {
      return;
    }
    modal.classList.remove('show');
    document.body.style.overflow = '';
    currentIndex = -1;
    isDragging = false;
    isTouchDragging = false;
    isPinching = false;
    resetTransform();
  }

  refreshModalImages();

  modalImg.addEventListener('dragstart', event => event.preventDefault());

  document.addEventListener('click', event => {
    const trigger = event.target.closest('.modal-trigger');
    if (!trigger) {
      return;
    }

    event.preventDefault();
    refreshModalImages();
    const index = modalImages.indexOf(trigger);
    openModalAtIndex(index > -1 ? index : 0);
  });

  modalClose?.addEventListener('click', closeModal);

  modal.addEventListener('click', event => {
    if (event.target === modal) {
      closeModal();
    }
  });

  document.addEventListener('keydown', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    switch (event.key) {
      case 'Escape':
        closeModal();
        break;
      case 'ArrowLeft':
        event.preventDefault();
        openModalAtIndex(currentIndex - 1);
        break;
      case 'ArrowRight':
        event.preventDefault();
        openModalAtIndex(currentIndex + 1);
        break;
      case '+':
      case '=':
        event.preventDefault();
        currentScale = Math.min(MAX_SCALE, currentScale + SCALE_STEP);
        applyTransform(true);
        break;
      case '-':
        event.preventDefault();
        currentScale = Math.max(MIN_SCALE, currentScale - SCALE_STEP);
        applyTransform(true);
        break;
      case '0':
        event.preventDefault();
        resetTransform();
        applyTransform(true);
        break;
      default:
        break;
    }
  });

  modal.addEventListener('wheel', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    event.preventDefault();
    const delta = event.deltaY > 0 ? -SCALE_STEP : SCALE_STEP;
    const nextScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, currentScale + delta));

    if (nextScale === currentScale) {
      return;
    }

    currentScale = nextScale;
    applyTransform(true);
  }, { passive: false });

  if (modalPrev) {
    modalPrev.addEventListener('click', event => {
      event.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex - 1);
    });
  }

  if (modalNext) {
    modalNext.addEventListener('click', event => {
      event.preventDefault();
      if (currentIndex === -1) {
        return;
      }
      openModalAtIndex(currentIndex + 1);
    });
  }

  modalImg.addEventListener('mousedown', event => {
    if (!modal.classList.contains('show') || currentScale <= MIN_SCALE) {
      return;
    }

    event.preventDefault();
    isDragging = true;
    dragStartX = event.clientX;
    dragStartY = event.clientY;
    modalImg.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', event => {
    if (!isDragging) {
      return;
    }

    event.preventDefault();
    translateX += event.clientX - dragStartX;
    translateY += event.clientY - dragStartY;
    dragStartX = event.clientX;
    dragStartY = event.clientY;
    applyTransform(false);
  });

  document.addEventListener('mouseup', () => {
    if (!isDragging) {
      return;
    }
    isDragging = false;
    modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
  });

  modalImg.addEventListener('touchstart', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.touches.length === 1 && currentScale > MIN_SCALE) {
      event.preventDefault();
      isTouchDragging = true;
      dragStartX = event.touches[0].clientX;
      dragStartY = event.touches[0].clientY;
      modalImg.style.cursor = 'grabbing';
    } else if (event.touches.length === 2) {
      event.preventDefault();
      isTouchDragging = false;
      isPinching = true;
      pinchStartDistance = getDistance(event.touches[0], event.touches[1]);
      pinchStartScale = currentScale;
      modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
    }
  }, { passive: false });

  modalImg.addEventListener('touchmove', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (isPinching && event.touches.length === 2) {
      event.preventDefault();
      const distance = getDistance(event.touches[0], event.touches[1]);
      if (pinchStartDistance > 0) {
        const scaleRatio = distance / pinchStartDistance;
        currentScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, pinchStartScale * scaleRatio));
        applyTransform(false);
      }
    } else if (isTouchDragging && event.touches.length === 1) {
      event.preventDefault();
      translateX += event.touches[0].clientX - dragStartX;
      translateY += event.touches[0].clientY - dragStartY;
      dragStartX = event.touches[0].clientX;
      dragStartY = event.touches[0].clientY;
      applyTransform(false);
    }
  }, { passive: false });

  modalImg.addEventListener('touchend', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.touches.length === 0) {
      isTouchDragging = false;
      modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
    }

    if (event.touches.length < 2) {
      isPinching = false;
      pinchStartDistance = 0;
      pinchStartScale = currentScale;
    }
  });

  modalImg.addEventListener('touchcancel', () => {
    if (!modal.classList.contains('show')) {
      return;
    }

    isTouchDragging = false;
    isPinching = false;
    pinchStartDistance = 0;
    pinchStartScale = currentScale;
    modalImg.style.cursor = currentScale > MIN_SCALE ? 'grab' : 'auto';
  });

  modal.addEventListener('touchend', event => {
    if (!modal.classList.contains('show')) {
      return;
    }

    if (event.target === modal && event.changedTouches.length === 1 && !isTouchDragging && !isPinching) {
      closeModal();
    }
  }, { passive: true });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-snippet-id]').forEach(caption => {
    const snippetId = caption.getAttribute('data-snippet-id');
    const snippetElement = document.getElementById(snippetId);

    if (snippetElement) {
      const content = snippetElement.textContent.replace(/"/g, '&quot;');
      caption.setAttribute('data-tooltip', content);
      caption.classList.add('diagram-caption');
    }
  });
});
</script>


  <!-- Floating Table of Contents -->
  <div id="floating-toc" class="floating-toc">
    <div class="toc-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
    </div>
    <div class="toc-content">
      <div class="toc-header">
        <span>Contents</span>
        <button class="toc-close" aria-label="Close table of contents">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <nav class="toc-nav" id="toc-nav">
        <!-- Generated by JavaScript -->
      </nav>
    </div>
  </div>

  <footer class="site-footer">
    <span>¬© 2026 glucolte ‚Ä¢ </span>
    <a href="https://github.com/gLuColte/glucolte.github.io">source</a>
  </footer>

  <script>
    // Dark mode functionality
    function initDarkMode() {
      const toggle = document.getElementById('dark-mode-toggle');
      const body = document.body;
      
      // Check for saved theme preference or default to light mode
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        body.setAttribute('data-theme', 'dark');
      }
      
      // Toggle dark mode
      if (toggle) {
        toggle.addEventListener('click', function() {
          const currentTheme = body.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          body.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      }
    }
    
    // Initialize dark mode immediately to prevent flash
    initDarkMode();
    
    // Initialize highlight.js and floating TOC after the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      hljs.highlightAll();
      
      // Floating TOC functionality - only show on sub-study pages
      const floatingToc = document.getElementById('floating-toc');
      const tocNav = document.getElementById('toc-nav');
      const tocClose = document.querySelector('.toc-close');
      
      // Check if we're on a sub-study page (not the main study index)
      const isSubStudyPage = window.location.pathname !== '/study/' && 
                            window.location.pathname !== '/study' && 
                            window.location.pathname.startsWith('/study/');
      
      if (floatingToc && tocNav && isSubStudyPage) {
        // Generate TOC from headings
        function generateTOC() {
          const headings = document.querySelectorAll('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6');
          if (headings.length === 0) {
            floatingToc.style.display = 'none';
            return;
          }
          
          const tocList = document.createElement('ul');
          let currentLevel = 0;
          let currentList = tocList;
          const listStack = [tocList];
          
          headings.forEach((heading, index) => {
            const level = parseInt(heading.tagName.charAt(1));
            const id = heading.id || `heading-${index}`;
            
            // Ensure heading has an ID
            if (!heading.id) {
              heading.id = id;
            }
            
            // Create list item
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = `#${id}`;
            link.textContent = heading.textContent.trim();
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const targetElement = document.getElementById(id);
              if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Close TOC after clicking
                floatingToc.classList.remove('toc-open');
              }
            });
            
            listItem.appendChild(link);
            
            // Handle nesting
            if (level > currentLevel) {
              // Go deeper
              for (let i = currentLevel; i < level; i++) {
                const newList = document.createElement('ul');
                currentList.appendChild(newList);
                listStack.push(newList);
                currentList = newList;
              }
            } else if (level < currentLevel) {
              // Go shallower
              for (let i = currentLevel; i > level; i--) {
                listStack.pop();
                currentList = listStack[listStack.length - 1];
              }
            }
            
            currentList.appendChild(listItem);
            currentLevel = level;
          });
          
          tocNav.appendChild(tocList);
        }
        
        // Generate the TOC
        generateTOC();
        
        // Handle close button
        if (tocClose) {
          tocClose.addEventListener('click', function() {
            floatingToc.classList.remove('toc-open');
          });
        }
        
        // Handle click on icon to toggle
        const tocIcon = document.querySelector('.toc-icon');
        if (tocIcon) {
          tocIcon.addEventListener('click', function() {
            floatingToc.classList.toggle('toc-open');
          });
        }
        
        // Active section highlighting
        function updateActiveSection() {
          const headings = document.querySelectorAll('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6');
          const tocLinks = tocNav.querySelectorAll('a');
          
          // Remove active class from all links
          tocLinks.forEach(link => link.classList.remove('active'));
          
          // Find the current section
          let currentHeading = null;
          const scrollPosition = window.scrollY + 100; // Offset for better UX
          
          for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            const headingTop = heading.offsetTop;
            
            if (headingTop <= scrollPosition) {
              currentHeading = heading;
              break;
            }
          }
          
          // Add active class to current section
          if (currentHeading) {
            const activeLink = tocNav.querySelector(`a[href="#${currentHeading.id}"]`);
            if (activeLink) {
              activeLink.classList.add('active');
            }
          }
        }
        
        // Update active section on scroll
        let scrollTimeout;
        window.addEventListener('scroll', function() {
          if (scrollTimeout) {
            clearTimeout(scrollTimeout);
          }
          scrollTimeout = setTimeout(updateActiveSection, 10);
        });
        
        // Initial update
        updateActiveSection();
      } else if (floatingToc && !isSubStudyPage) {
        // Hide floating TOC on main study page
        floatingToc.style.display = 'none';
      }
      
      // Legacy TOC functionality (for existing markdown TOCs)
      const toc = document.querySelector('#markdown-toc');
      if (toc) {
        // Hide the floating TOC if there's already a markdown TOC
        if (floatingToc) {
          floatingToc.style.display = 'none';
        }
        
        // Create TOC container with header
        const tocContainer = document.createElement('div');
        tocContainer.className = 'toc-container';
        tocContainer.style.cssText = `
          background: #f8fafc;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 16px;
          margin: 20px 0;
          position: relative;
        `;
        
        // Add TOC header
        const tocHeader = document.createElement('h3');
        tocHeader.textContent = 'Table of Contents';
        tocHeader.style.cssText = `
          margin: 0 0 12px 0;
          font-size: 16px;
          font-weight: 600;
          color: #374151;
        `;
        
        // Add back to top button
        const backToTopBtn = document.createElement('button');
        backToTopBtn.textContent = '‚Üë Top';
        backToTopBtn.style.cssText = `
          position: absolute;
          top: 12px;
          right: 12px;
          background: #ffffff;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          padding: 4px 8px;
          font-size: 12px;
          cursor: pointer;
          color: #6b7280;
          transition: all 0.2s ease;
        `;
        
        // Add hover effect for back to top button
        backToTopBtn.addEventListener('mouseenter', function() {
          this.style.background = '#f3f4f6';
          this.style.color = '#374151';
        });
        
        backToTopBtn.addEventListener('mouseleave', function() {
          this.style.background = '#ffffff';
          this.style.color = '#6b7280';
        });
        
        // Back to top functionality
        backToTopBtn.addEventListener('click', function() {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Style the TOC list
        toc.style.cssText = `
          margin: 0;
          padding: 0;
          font-size: 14px;
          line-height: 1.5;
        `;
        
        // Insert header and button into container
        tocContainer.appendChild(tocHeader);
        tocContainer.appendChild(backToTopBtn);
        tocContainer.appendChild(toc);
        
        // Replace the original TOC with the new container
        toc.parentNode.insertBefore(tocContainer, toc);
        tocContainer.appendChild(toc);
        
        // Add smooth scrolling to TOC links
        const tocLinks = toc.querySelectorAll('a');
        tocLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: 'smooth' });
            }
          });
        });
      }
    });
  </script>
</body>
</html>
